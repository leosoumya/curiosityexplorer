<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curiosity Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Trebuchet MS', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            position: relative;
        }

        h1 {
            color: #ff6b6b;
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            color: #4ecdc4;
            font-size: 32px;
            text-align: center;
            margin-bottom: 30px;
        }

        .subtitle {
            color: #95a5a6;
            font-size: 20px;
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            min-width: 200px;
            margin: 10px;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-success:hover {
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.6);
        }

        .btn-large {
            font-size: 32px;
            padding: 30px 60px;
            margin: 20px auto;
            display: block;
        }

        .mission-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .mission-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
        }

        .mission-card:hover {
            transform: scale(1.05);
            border-color: #ff6b6b;
        }

        .mission-card h3 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .mission-card p {
            color: #34495e;
            font-size: 18px;
        }

        .plane-visual {
            width: 100%;
            height: 300px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            border-radius: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 3px solid #4ecdc4;
        }

        .plane {
            position: absolute;
            font-size: 60px;
            transition: all 1s ease;
        }

        /* Custom SVG Plane Styles */
        .plane-svg {
            position: absolute;
            width: 120px;
            height: 80px;
            transition: all 2s ease;
            left: 30px;
            top: 120px;
        }

        .plane-body {
            fill: #5a9fd4;
            stroke: #2c3e50;
            stroke-width: 2;
        }

        .plane-wing {
            fill: #f39c12;
            stroke: #2c3e50;
            stroke-width: 2;
        }

        .plane-tail {
            fill: #e74c3c;
            stroke: #2c3e50;
            stroke-width: 2;
        }

        .plane-nose {
            fill: #3498db;
            stroke: #2c3e50;
            stroke-width: 2;
        }

        .plane-window {
            fill: #ecf0f1;
            stroke: #2c3e50;
            stroke-width: 1;
        }

        /* Flight animations */
        @keyframes flyGreat {
            0% { left: 30px; top: 180px; transform: rotate(0deg); }
            30% { top: 80px; transform: rotate(-15deg); }
            100% { left: 85%; top: 50px; transform: rotate(-10deg); }
        }

        @keyframes flyOkay {
            0% { left: 30px; top: 180px; transform: rotate(0deg); }
            25% { top: 120px; transform: rotate(-8deg); }
            50% { top: 100px; transform: rotate(-5deg); }
            100% { left: 55%; top: 110px; transform: rotate(-3deg); }
        }

        @keyframes flyPoor {
            0% { left: 30px; top: 180px; transform: rotate(0deg); }
            15% { top: 160px; transform: rotate(-5deg); }
            30% { top: 170px; transform: rotate(5deg); }
            45% { top: 150px; transform: rotate(-8deg); }
            60% { top: 180px; transform: rotate(10deg); }
            75% { top: 200px; transform: rotate(5deg); }
            100% { left: 30%; top: 230px; transform: rotate(15deg); }
        }

        @keyframes flyImproved {
            0% { left: 30px; top: 150px; transform: rotate(0deg); }
            20% { top: 80px; transform: rotate(-15deg); }
            100% { left: 90%; top: 30px; transform: rotate(-12deg); }
        }

        .flight-great { animation: flyGreat 3s ease-out forwards; }
        .flight-okay { animation: flyOkay 3s ease-out forwards; }
        .flight-poor { animation: flyPoor 3s ease-in-out forwards; }
        .flight-improved { animation: flyImproved 2.5s ease-out forwards; }

        /* Trail effect */
        .smoke-trail {
            position: absolute;
            width: 15px;
            height: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: smoke 1s ease-out forwards;
        }

        @keyframes smoke {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(3) translateX(-30px); }
        }

        /* Ground/runway */
        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, #7cb342 0%, #558b2f 100%);
            border-top: 3px solid #33691e;
        }

        .runway {
            position: absolute;
            bottom: 0;
            left: 20px;
            width: 100px;
            height: 40px;
            background: #424242;
        }

        .runway-line {
            position: absolute;
            bottom: 18px;
            left: 30px;
            width: 80px;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #fff 0px,
                #fff 10px,
                transparent 10px,
                transparent 20px
            );
        }

        /* Distance markers */
        .distance-marker {
            position: absolute;
            bottom: 50px;
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        /* Sun */
        .sun {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #f1c40f;
            border-radius: 50%;
            box-shadow: 0 0 30px #f39c12;
        }

        /* Flight result labels */
        .flight-label {
            position: absolute;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            animation: fadeInLabel 0.5s ease-out 2.5s forwards;
        }

        @keyframes fadeInLabel {
            to { opacity: 1; }
        }

        .label-great {
            background: #27ae60;
            color: white;
            top: 30px;
            right: 50px;
        }

        .label-okay {
            background: #f39c12;
            color: white;
            top: 90px;
            right: 180px;
        }

        .label-poor {
            background: #e74c3c;
            color: white;
            bottom: 60px;
            left: 25%;
        }

        .plane-parts-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .part-option {
            background: #fff;
            border: 3px solid #4ecdc4;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .part-option:hover {
            background: #e8f8f7;
            transform: scale(1.05);
        }

        .part-option.selected {
            background: #4ecdc4;
            color: white;
            border-color: #2c3e50;
        }

        .part-option .label {
            font-size: 18px;
            font-weight: bold;
        }

        .feedback-box {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            border: 3px solid #f39c12;
            text-align: center;
            font-size: 20px;
            line-height: 1.6;
            color: #2c3e50;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .choice-btn {
            background: white;
            border: 3px solid #4ecdc4;
            padding: 25px 35px;
            font-size: 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            color: #2c3e50;
            min-width: 250px;
            text-align: left;
        }

        .choice-btn:hover {
            background: #e8f8f7;
            transform: translateY(-3px);
            border-color: #ff6b6b;
        }

        .choice-btn.selected {
            background: #4ecdc4;
            color: white;
            border-color: #2c3e50;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 50%, #B8860B 100%);
            color: #5D4E37;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            margin: 8px;
            border: 3px solid #DAA520;
            box-shadow:
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.4),
                inset 0 -2px 4px rgba(0,0,0,0.1);
            animation: badgeAppear 0.6s ease;
            cursor: default;
            position: relative;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
        }

        .badge::before {
            content: 'üèÜ';
            margin-right: 8px;
            font-size: 20px;
        }

        .badge::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 100%);
            border-radius: 10px 10px 0 0;
            pointer-events: none;
        }

        @keyframes badgeAppear {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .badge-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 30px 0;
        }

        /* Chat Interface Styles */
        .chat-container {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 20px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            min-height: 200px;
            max-height: 380px;
        }

        .chat-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            margin-bottom: 12px;
            max-width: 95%;
            line-height: 1.5;
            font-size: 16px;
            animation: slideIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .chat-bubble.assistant {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .chat-bubble.thinking {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.1);
        }

        .voice-btn.listening {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .send-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .celebration {
            text-align: center;
            padding: 40px 20px;
        }

        .celebration-emoji {
            font-size: 100px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes wobble {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .bounce-animation {
            animation: bounce 0.5s ease 2;
        }

        .wobble-animation {
            animation: wobble 0.5s ease 2;
        }

        .parent-view {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .parent-view h3 {
            color: #495057;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .skill-list {
            list-style: none;
            padding: 0;
        }

        .skill-list li {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 5px solid #4ecdc4;
            font-size: 18px;
            color: #2c3e50;
        }

        .back-btn {
            background: #95a5a6;
            font-size: 18px;
            padding: 15px 30px;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #7f8c8d;
        }

        .progress-indicator {
            text-align: center;
            font-size: 32px;
            margin-bottom: 20px;
            letter-spacing: 8px;
        }

        .progress-indicator .star {
            color: #ddd;
            transition: all 0.3s ease;
        }

        .progress-indicator .star.filled {
            color: #f1c40f;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.7;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            from { left: -100px; }
            to { left: 100%; }
        }

        .flight-path {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 0;
            height: 3px;
            background: rgba(255, 107, 107, 0.5);
            transition: width 2s ease;
        }

        .question-mark {
            font-size: 80px;
            text-align: center;
            color: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Topic Input Styles */
        .topic-input-container {
            text-align: center;
            margin: 30px 0;
        }

        .topic-input {
            font-family: inherit;
            font-size: 32px;
            padding: 20px 30px;
            border: 4px solid #4ecdc4;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .topic-input:focus {
            outline: none;
            border-color: #ff6b6b;
            transform: scale(1.05);
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
            max-width: 500px;
        }

        .topic-card-big {
            background: white;
            border: 4px solid #4ecdc4;
            border-radius: 20px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 140px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .topic-card-big:hover, .topic-card-big:active {
            transform: scale(1.05);
            border-color: #ff6b6b;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .topic-card-big .topic-icon {
            font-size: 60px;
            margin-bottom: 8px;
        }

        .topic-card-big .topic-label {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .parent-corner-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .parent-corner-btn:hover {
            background: #f0f0f0;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
            max-width: 350px;
        }

        .avatar-btn {
            background: white;
            border: 4px solid #4ecdc4;
            border-radius: 20px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar-btn:hover, .avatar-btn:active {
            transform: scale(1.1);
            border-color: #ff6b6b;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .avatar-icon {
            font-size: 50px;
            margin-bottom: 5px;
        }

        .avatar-name {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }

        .say-topic-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .say-topic-btn:hover, .say-topic-btn:active {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .say-topic-btn.listening {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ask-anything-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .ask-anything-btn:hover, .ask-anything-btn:active {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .topic-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 25px;
            border: 3px solid #4ecdc4;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #ff6b6b;
        }

        .topic-card-header {
            font-size: 28px;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: bold;
        }

        .topic-card-meta {
            font-size: 14px;
            color: #95a5a6;
            margin-bottom: 15px;
        }

        .topic-card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .mini-badge {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 50%, #B8860B 100%);
            color: #5D4E37;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #DAA520;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: default;
        }

        /* Recap Styles */
        .recap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .recap-card {
            background: white;
            border: 3px solid #4ecdc4;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recap-card:hover {
            background: #e8f8f7;
            transform: scale(1.05);
        }

        .recap-card-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .recap-card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .recap-card-content {
            font-size: 16px;
            color: #34495e;
            line-height: 1.4;
        }

        .concept-bubble {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 3px solid #4ecdc4;
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            font-size: 20px;
            color: #2c3e50;
            animation: bounceIn 0.6s ease;
        }

        .welcome-back-banner {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border: 3px solid #f39c12;
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }

        .welcome-back-banner h3 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-back-banner p {
            color: #34495e;
            font-size: 18px;
            line-height: 1.6;
        }

        /* Menu button styles */
        .menu-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.2s;
        }

        .menu-btn:hover {
            transform: scale(1.05);
        }

        .menu-btn span {
            display: block;
            width: 20px;
            height: 3px;
            background: #2c3e50;
            border-radius: 2px;
        }

        /* About modal styles */
        .about-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .about-modal.active {
            display: flex;
        }

        .about-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .about-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .about-close:hover {
            background: #e0e0e0;
        }

        .about-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-right: 40px;
        }

        .about-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .about-section h4 {
            color: #4ecdc4;
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .about-section p {
            color: #555;
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Floating Home Button */
        .floating-home-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-home-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.6);
        }

        .floating-home-btn:active {
            transform: scale(0.95);
        }

        /* Mute Button */
        .mute-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mute-btn:hover {
            transform: scale(1.1);
        }

        .mute-btn.muted {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti-fall 3s ease-out forwards;
        }

        .confetti.square {
            border-radius: 2px;
        }

        .confetti.circle {
            border-radius: 50%;
        }

        .confetti.triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid currentColor;
            background: none !important;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }

            h1 {
                font-size: 1.8em !important;
            }

            h2 {
                font-size: 1.4em !important;
            }

            .topic-btn, .mission-btn {
                padding: 18px 15px !important;
                font-size: 1.1em !important;
                min-height: 70px;
            }

            .answer-btn {
                padding: 20px !important;
                font-size: 1.2em !important;
                min-height: 80px;
            }

            .chat-container {
                height: 50vh !important;
                min-height: 300px;
            }

            .chat-bubble {
                max-width: 90% !important;
                font-size: 1.1em !important;
                padding: 12px 16px !important;
            }

            #questionInput {
                font-size: 1.1em !important;
                padding: 15px !important;
            }

            .input-row button {
                padding: 15px 20px !important;
                font-size: 1em !important;
            }

            .home-btn {
                width: 55px !important;
                height: 55px !important;
                font-size: 1.6em !important;
            }

            .mute-btn {
                width: 50px !important;
                height: 50px !important;
            }

            .badge {
                font-size: 2.5em !important;
                padding: 15px !important;
            }

            /* Stack buttons vertically on small screens */
            .input-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .input-row input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em !important;
            }

            .topic-btn, .mission-btn {
                font-size: 1em !important;
                padding: 15px 12px !important;
            }

            .home-btn {
                bottom: 15px !important;
                left: 15px !important;
            }
        }
    </style>
    <!-- GoatCounter Analytics -->
    <script data-goatcounter="https://curiosityexplorer.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
</head>
<body>
    <!-- Menu Button -->
    <button class="menu-btn" onclick="toggleAboutModal()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Floating Home Button -->
    <button class="floating-home-btn" onclick="goHome()" title="Go Home">
        üè†
    </button>

    <!-- Mute Button for Speech -->
    <button class="mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute">
        üîä
    </button>

    <!-- About Modal -->
    <div class="about-modal" id="aboutModal" onclick="closeAboutModalOutside(event)">
        <div class="about-content" onclick="event.stopPropagation()">
            <button class="about-close" onclick="toggleAboutModal()">‚úï</button>
            <h2>üåü About Curiosity Explorer</h2>

            <div class="about-section">
                <h4>üéØ What is this app?</h4>
                <p>A fun app for kids ages 4-8! Kids explore topics they love. They learn smart thinking through play.</p>
            </div>

            <div class="about-section">
                <h4>üß† How does it help kids learn?</h4>
                <p>Kids think through problems. They test ideas and find mistakes. No scores or grades here. Just fun exploring!</p>
            </div>

            <div class="about-section">
                <h4>üìö Three Types of Missions</h4>
                <p><strong>1. Build & Test:</strong> Make something and see how it works<br>
                <strong>2. Spot the Mistake:</strong> Find facts that seem wrong<br>
                <strong>3. Make a Choice:</strong> Think about what matters most</p>
            </div>

            <div class="about-section">
                <h4>üë®‚Äçüë©‚Äçüëß For Parents</h4>
                <p>Click "Parent View" to see what your child learned. You can see topics and facts they found.</p>
            </div>

            <div class="about-section">
                <h4>üíæ Progress is Saved</h4>
                <p>Progress saves on its own. Kids can come back anytime!</p>
            </div>

            <!-- Contact/Feedback Section -->
            <div class="about-section" style="background: #e3f2fd; border: 2px solid #2196f3;">
                <h4>üì¨ Share Your Feedback</h4>
                <div id="feedbackForm">
                    <p style="margin-bottom: 10px;">We'd love to hear from you! Share suggestions, ideas, or tell us how your child is enjoying the app.</p>
                    <textarea
                        id="feedbackText"
                        placeholder="Type your feedback here..."
                        style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                    ></textarea>
                    <input
                        type="email"
                        id="feedbackEmail"
                        placeholder="Your email (optional)"
                        style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; margin-top: 10px; box-sizing: border-box;"
                    />
                    <button
                        onclick="submitFeedback()"
                        style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s;"
                        onmouseover="this.style.background='#1976d2'"
                        onmouseout="this.style.background='#2196f3'"
                    >
                        Send Feedback üì§
                    </button>
                </div>
                <div id="feedbackSuccess" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">‚úÖ</div>
                    <p style="color: #2e7d32; font-weight: bold; margin: 0;">Thank you for your feedback!</p>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">We appreciate you taking the time to share your thoughts.</p>
                    <button
                        onclick="resetFeedbackForm()"
                        style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 10px;"
                    >
                        Send Another
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px; color: #888; font-size: 13px;">
                Made with ‚ù§Ô∏è to nurture curiosity<br>
                <a href="mailto:curiosityexplorer.feedback@gmail.com" style="color: #2196f3; text-decoration: none;">curiosityexplorer.feedback@gmail.com</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Name Entry Screen - Avatar Selection -->
        <div id="nameEntry" class="screen">
            <h1>üåü Curiosity Explorer üåü</h1>
            <div class="celebration-emoji">üëã</div>
            <h2>Who are you today?</h2>
            <p class="subtitle">Tap to pick!</p>

            <div class="avatar-grid">
                <button class="avatar-btn" onclick="selectAvatar('ü¶Å', 'Lion')">
                    <span class="avatar-icon">ü¶Å</span>
                    <span class="avatar-name">Lion</span>
                </button>
                <button class="avatar-btn" onclick="selectAvatar('üöÄ', 'Rocket')">
                    <span class="avatar-icon">üöÄ</span>
                    <span class="avatar-name">Rocket</span>
                </button>
                <button class="avatar-btn" onclick="selectAvatar('ü¶ï', 'Dino')">
                    <span class="avatar-icon">ü¶ï</span>
                    <span class="avatar-name">Dino</span>
                </button>
                <button class="avatar-btn" onclick="selectAvatar('‚≠ê', 'Star')">
                    <span class="avatar-icon">‚≠ê</span>
                    <span class="avatar-name">Star</span>
                </button>
                <button class="avatar-btn" onclick="selectAvatar('üê¨', 'Dolphin')">
                    <span class="avatar-icon">üê¨</span>
                    <span class="avatar-name">Dolphin</span>
                </button>
                <button class="avatar-btn" onclick="selectAvatar('ü§ñ', 'Robot')">
                    <span class="avatar-icon">ü§ñ</span>
                    <span class="avatar-name">Robot</span>
                </button>
            </div>

            <!-- Hidden input for compatibility -->
            <input type="hidden" id="nameInput" value="Explorer" />
        </div>

        <!-- Welcome Screen - Big Visual Topic Cards -->
        <div id="welcome" class="screen">
            <!-- Parent settings button in corner -->
            <button class="parent-corner-btn" onclick="showScreen('parentView')" title="Parent Settings">‚öôÔ∏è</button>

            <h1>üåü Pick a Topic! üåü</h1>
            <p class="subtitle">Hi <span id="userName">Explorer</span>! Tap one to start!</p>

            <div class="topic-grid">
                <button class="topic-card-big" onclick="selectTopicAndStart('planes')">
                    <span class="topic-icon">‚úàÔ∏è</span>
                    <span class="topic-label">Planes</span>
                </button>
                <button class="topic-card-big" onclick="selectTopicAndStart('dinosaurs')">
                    <span class="topic-icon">ü¶ï</span>
                    <span class="topic-label">Dinosaurs</span>
                </button>
                <button class="topic-card-big" onclick="selectTopicAndStart('space')">
                    <span class="topic-icon">üöÄ</span>
                    <span class="topic-label">Space</span>
                </button>
                <button class="topic-card-big" onclick="selectTopicAndStart('ocean')">
                    <span class="topic-icon">üåä</span>
                    <span class="topic-label">Ocean</span>
                </button>
                <button class="topic-card-big" onclick="selectTopicAndStart('robots')">
                    <span class="topic-icon">ü§ñ</span>
                    <span class="topic-label">Robots</span>
                </button>
                <button class="topic-card-big" onclick="selectTopicAndStart('stars')">
                    <span class="topic-icon">‚≠ê</span>
                    <span class="topic-label">Stars</span>
                </button>
            </div>

            <!-- Say or type your own topic -->
            <button class="say-topic-btn" onclick="sayMyTopic()" id="sayTopicBtn">
                <span style="font-size: 32px;">üé§</span>
                <span>Say Something Else!</span>
            </button>
            <p id="sayTopicStatus" style="color: #888; font-size: 14px; margin-top: 10px; display: none;"></p>

            <!-- Fallback text input for custom topic -->
            <div id="customTopicInput" style="display: none; margin-top: 15px;">
                <input type="text" id="customTopicText" placeholder="Type a topic..."
                       style="padding: 12px 20px; font-size: 18px; border: 3px solid #4ecdc4; border-radius: 25px; width: 200px; text-align: center; font-family: inherit;">
                <button onclick="startCustomTopic()" style="background: #4ecdc4; color: white; border: none; border-radius: 25px; padding: 12px 20px; font-size: 18px; font-weight: bold; cursor: pointer; margin-left: 10px;">Go!</button>
            </div>

            <!-- Ask Me Anything -->
            <button class="ask-anything-btn" onclick="showScreen('askQuestion')">
                <span style="font-size: 32px;">üí¨</span>
                <span>Ask Me Anything!</span>
            </button>
        </div>

        <!-- Ask a Question Screen -->
        <div id="askQuestion" class="screen">
            <h2>ü§î Ask Me Anything!</h2>
            <p class="subtitle">I'll help you learn about anything!</p>

            <!-- API Key Setup (one-time for parents) -->
            <div id="apiKeySetup" style="display: none; background: #e3f2fd; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <p style="color: #1565c0; margin-bottom: 10px;"><strong>üë®‚Äçüë©‚Äçüëß Parent Setup (one-time):</strong></p>
                <p style="color: #555; font-size: 14px; margin-bottom: 15px;">
                    Enter your OpenAI API key to enable AI chat.<br>
                    <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #1976d2;">Get one here</a> (requires OpenAI account)
                </p>
                <input
                    type="password"
                    id="openaiKeyInput"
                    placeholder="sk-..."
                    style="width: 100%; padding: 12px; border: 2px solid #90caf9; border-radius: 10px; font-size: 14px; box-sizing: border-box;"
                />
                <button onclick="saveOpenAIKey()" style="margin-top: 10px; padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    Save & Start
                </button>
            </div>

            <!-- Chat Container -->
            <div id="chatContainer" class="chat-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-bubble assistant">
                        Hi! What are you curious about today? Ask me anything! üåü
                    </div>
                </div>

                <div class="chat-input-area">
                    <input
                        type="text"
                        id="questionInput"
                        class="chat-input"
                        placeholder="Type your question..."
                        maxlength="200"
                    />
                    <button id="clearBtn" class="voice-btn" onclick="clearQuestionInput()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);" title="Clear">
                        ‚úï
                    </button>
                    <button id="voiceBtn" class="voice-btn" onclick="startVoiceInput()" title="Speak">
                        üé§
                    </button>
                    <button class="send-btn" onclick="sendQuestion()">
                        Send
                    </button>
                </div>
            </div>

            <div style="margin-top: 20px; display: none;">
            </div>
        </div>

        <!-- My Curiosity Dashboard -->
        <div id="dashboard" class="screen">
            <h2>üèÜ My Curiosity Dashboard üèÜ</h2>
            <p class="subtitle">All the amazing things you've explored!</p>

            <div id="dashboardContent" class="dashboard-grid"></div>

            <div class="feedback-box" id="emptyDashboard" style="display: none;">
                No explorations yet!<br>
                Pick a topic and start your adventure!
            </div>

            <button class="btn btn-primary" onclick="showScreen('welcome')">Explore Something New</button>
        </div>

        <!-- Mission Selection Screen -->
        <div id="missionSelect" class="screen">
            <div id="welcomeBackBanner"></div>
            <h2 id="missionSelectTitle">Choose Your Mission</h2>
            <div class="mission-grid" id="missionGrid">
                <!-- Missions will be dynamically inserted here -->
            </div>
            <button class="btn back-btn" onclick="showScreen('welcome')">Pick Different Topic</button>
            <button class="btn back-btn" onclick="showScreen('hangar')">My Badges</button>
            <button class="btn btn-success" onclick="showRecap()" id="recapBtn" style="display: none;">See What I Learned!</button>
        </div>

        <!-- Mission 2: Spot the Mistake -->
        <div id="mission2-intro" class="screen">
            <div class="celebration-emoji" style="font-size: 80px;">üîç</div>
            <h2>Find the Silly One!</h2>
            <p class="subtitle">Which one sounds wrong?</p>
            <button class="btn btn-large btn-primary" onclick="startMission2Questions()" style="font-size: 24px; padding: 20px 50px;">
                Let's Go!
            </button>
        </div>

        <div id="mission2-facts" class="screen">
            <div class="progress-indicator" id="mission2Progress">
                <span class="star">‚òÜ</span><span class="star">‚òÜ</span><span class="star">‚òÜ</span><span class="star">‚òÜ</span><span class="star">‚òÜ</span>
            </div>
            <h2>Which sounds silly?</h2>

            <div class="button-group" style="flex-direction: column; align-items: center; margin-top: 30px;">
                <button class="choice-btn" onclick="checkFact('correct')">
                    ‚úàÔ∏è Planes have wings to help them fly
                </button>
                <button class="choice-btn" onclick="checkFact('wrong')">
                    üöó Planes drive on roads to take off
                </button>
            </div>
            <button class="btn back-btn" onclick="showScreen('missionSelect')" style="margin-top: 20px;">üè† Back</button>
        </div>

        <div id="mission2-correct" class="screen">
            <div class="celebration">
                <div class="celebration-emoji bounce-animation">üéâ</div>
                <h2>Yes!</h2>
                <p class="subtitle" id="mission2CorrectFeedback"></p>
                <div id="mission2CorrectProgress" class="progress-indicator" style="margin: 20px 0;"></div>
                <button class="btn btn-large btn-primary" onclick="nextMission2Question()" style="font-size: 22px;">
                    Next!
                </button>
            </div>
        </div>

        <div id="mission2-hint" class="screen">
            <div class="celebration-emoji wobble-animation">ü§î</div>
            <h2>Try Again!</h2>
            <p class="subtitle" id="mission2HintBox">That one was true!</p>
            <button class="btn btn-large btn-primary" onclick="showScreen('mission2-facts')" style="font-size: 22px; margin-top: 20px;">
                Let's Try!
            </button>
        </div>

        <div id="mission2-success" class="screen">
            <div class="celebration">
                <div class="celebration-emoji bounce-animation">üèÜ</div>
                <h2>Amazing!</h2>
                <p class="subtitle">You found all 5!</p>
                <div class="badge-container" id="mission2BadgeDisplay">
                    <div class="badge">üîç Fact Finder</div>
                </div>
                <button class="btn btn-large btn-success" onclick="completeMission(2)" style="font-size: 22px; margin-top: 20px;">
                    Yay!
                </button>
            </div>
        </div>

        <!-- Interactive Recap Screen -->
        <div id="recap" class="screen">
            <div class="celebration">
                <div class="celebration-emoji">üéâ</div>
                <h2 id="recapTitle">What You Discovered!</h2>
                <p class="subtitle" id="recapSubtitle">Amazing work, explorer!</p>

                <div style="background: white; border-radius: 20px; padding: 30px; margin: 20px 0; border: 3px solid #4ecdc4;">
                    <h3 style="color: #2c3e50; font-size: 24px; margin-bottom: 20px;">Key Ideas You Explored:</h3>
                    <div id="conceptsLearned"></div>
                </div>

                <div class="recap-grid" id="recapGrid">
                    <!-- Dynamically filled recap cards -->
                </div>

                <p class="subtitle" style="margin-top: 30px;">Badges You Earned Today:</p>
                <div class="badge-container" id="recapBadges"></div>

                <button class="btn btn-success btn-large" onclick="finishSession()">Finish Exploring!</button>
                <button class="btn btn-primary" onclick="showScreen('missionSelect')">Do More Missions</button>
                <button class="btn back-btn" onclick="showScreen('welcome')">üè† Home</button>
            </div>
        </div>

        <!-- Hangar (Badge Collection) -->
        <div id="hangar" class="screen">
            <h2>üèÜ Your Badges üèÜ</h2>
            <p class="subtitle" id="hangarSubtitle">Look at your badges!</p>
            <div class="badge-container" id="badgeDisplay"></div>
            <div class="feedback-box" style="margin-top: 30px;">
                Keep playing to earn more badges!
            </div>
            <button class="btn btn-primary" onclick="showScreen('missionSelect')">Pick Another Mission</button>
            <button class="btn back-btn" onclick="showScreen('welcome')">Back to Home</button>
        </div>

        <!-- Parent View -->
        <div id="parentView" class="screen">
            <h2>üë®‚Äçüë©‚Äçüëß Parent Dashboard</h2>
            <div class="parent-view">

                <!-- Quick Summary Card -->
                <div id="parentSummaryCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 20px; margin-bottom: 25px; color: white; text-align: center;">
                    <h3 style="margin-bottom: 15px; font-size: 18px;">This Week</h3>
                    <div style="display: flex; justify-content: space-around; gap: 15px;">
                        <div>
                            <div id="summaryTopics" style="font-size: 36px; font-weight: bold;">0</div>
                            <div style="font-size: 14px; opacity: 0.9;">Topics</div>
                        </div>
                        <div>
                            <div id="summaryBadges" style="font-size: 36px; font-weight: bold;">0</div>
                            <div style="font-size: 14px; opacity: 0.9;">Badges</div>
                        </div>
                        <div>
                            <div id="summaryMissions" style="font-size: 36px; font-weight: bold;">0</div>
                            <div style="font-size: 14px; opacity: 0.9;">Games</div>
                        </div>
                    </div>
                </div>

                <!-- Topics Explored with Details -->
                <div id="parentTopicsLearned" style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #495057; margin-bottom: 15px;">üìö Recent Activity</h3>
                    <div id="parentTopicsList">
                        <p style="color: #888; font-style: italic;">No activity yet. Play a game to see progress!</p>
                    </div>
                </div>

                <!-- Skills as Visual Icons -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #495057; margin-bottom: 15px;">üß† Skills Practiced</h3>
                    <div class="skills-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div class="skill-tile" id="skillChecking" style="background: #e8f5e9; padding: 15px 10px; border-radius: 12px;">
                            <div style="font-size: 28px;">üîç</div>
                            <div style="font-size: 12px; color: #2e7d32; margin-top: 5px;">Fact Checking</div>
                        </div>
                        <div class="skill-tile" style="background: #e3f2fd; padding: 15px 10px; border-radius: 12px; opacity: 0.5;">
                            <div style="font-size: 28px;">‚ùì</div>
                            <div style="font-size: 12px; color: #1976d2; margin-top: 5px;">Asking Why</div>
                        </div>
                        <div class="skill-tile" style="background: #fff3e0; padding: 15px 10px; border-radius: 12px; opacity: 0.5;">
                            <div style="font-size: 28px;">üîß</div>
                            <div style="font-size: 12px; color: #e65100; margin-top: 5px;">Problem Solving</div>
                        </div>
                    </div>
                    <p style="color: #999; font-size: 12px; margin-top: 12px; text-align: center;">Faded = not practiced yet</p>
                </div>

                <!-- API Key Setup -->
                <div style="background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ddd;">
                    <h3 style="color: #495057; margin-bottom: 10px;">üîë Setup</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Enter your OpenAI API key to enable the Q&A feature.
                        <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">Get one here</a>
                    </p>
                    <input type="password" id="parentApiKeyInput" placeholder="sk-..."
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 10px;"
                           onchange="saveParentApiKey(this.value)">
                    <p id="apiKeyStatus" style="color: #27ae60; font-size: 12px;"></p>
                </div>

                <!-- Feedback link (low-key) -->
                <p style="text-align: center; margin-top: 20px;">
                    <a href="mailto:curiosityexplorer.feedback@gmail.com" style="color: #999; font-size: 14px;">
                        Share feedback ‚Üí
                    </a>
                </p>
            </div>
            <button class="btn back-btn" onclick="showScreen('welcome')">Back to Home</button>
        </div>
    </div>

    <script>
        // State management with localStorage persistence
        const gameState = {
            currentTopic: null,
            currentTopicData: null,
            completedMissions: [],
            currentPlane: {
                wings: null,
                nose: null
            },
            badges: [],
            conceptsLearned: [],
            questionsAsked: [],
            ideasTested: []
        };

        // ========== SOUND EFFECTS ==========
        // Base64 encoded sounds (short chimes)
        // Correct answer: cheerful chime
        const correctSoundData = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJOtrrKwn4x/d3yJoLW4tKaVhHlzdH6RpbC0s6qYiHpwcnZ+jaGvtrWvooNzZ2Zsdo6grLSzsqiZjH9zdXeBkZ+qsrKvqJuLfHR0dXyIl6OsrrCqopuMfXZ2enmEkpymsLCso5iJfHZ2dXmDkJukq66qpJyOgXd4eHqCjpifqKypp5+Sg3t4eHl/iZOdpKippqGXin96eXl7gIuSmKGlpqOfl5GLgHx7e32CiY+Xn6OjoZ2YkYuDf316fICFi5GYnJ6dnJmUjoiEgX9+f4GEiY2SmJqamJaTj4qGhIKAf4CDhYiLj5OVlpWTkY6LiIaDgoGBgoSGiIqNj5GSkZCOjIqIhoWDgoKDhIaHiYuMjo6NjIuKiIeGhYSEhISFhoaIiYqLi4uKiomIh4aGhYWFhYWGhoeIiImJiYmIiIeHhoaGhYaGhoaGh4eHiIiIiIeHh4aGhoaGhoaGhoaGh4eHh4eHh4eHhoaGhoaGhoaGhoaGhoaGh4eHh4eHh4eGhoaGhoaGhoaGhoaGhoaGhoaGh4eHh4eHhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaG';

        // Wrong answer: gentle "try again" tone
        const wrongSoundData = 'data:audio/wav;base64,UklGRlwDAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTgDAACAf39/gIGCgoKBgH9/f4CAgYGBgYGAgH9/f39/gICAgICAgH9/f39/f4CAgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAgH9/f39/f4CAgICAgH9/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAgH9/f39/f4CAgICAgH9/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAgH9/f39/f4CAgICAgH9/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICAgICAf39/f39/f4CAgICAgH9/f39/f3+AgICAgIB/f39/f39/gICA';

        let correctSound = null;
        let wrongSound = null;

        function initSounds() {
            correctSound = new Audio(correctSoundData);
            correctSound.volume = 0.5;
            wrongSound = new Audio(wrongSoundData);
            wrongSound.volume = 0.3;
        }

        function playCorrectSound() {
            if (correctSound && !isMuted) {
                correctSound.currentTime = 0;
                correctSound.play().catch(e => console.log('Sound play error:', e));
            }
        }

        function playWrongSound() {
            if (wrongSound && !isMuted) {
                wrongSound.currentTime = 0;
                wrongSound.play().catch(e => console.log('Sound play error:', e));
            }
        }

        // Initialize sounds on first user interaction
        document.addEventListener('click', function initOnClick() {
            initSounds();
            document.removeEventListener('click', initOnClick);
        }, { once: true });

        // ========== TEXT-TO-SPEECH (OpenAI TTS) ==========
        let isMuted = localStorage.getItem('curiosityMuted') === 'true';
        let currentAudio = null;

        function cleanTextForSpeech(text) {
            return text
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert [text](url) to just text
                .replace(/<a[^>]*>([^<]*)<\/a>/gi, '$1') // Remove HTML links, keep text
                .replace(/https?:\/\/[^\s\])]+/g, '') // Remove plain URLs
                .replace(/www\.[^\s\])]+/g, '') // Remove www links
                .replace(/\[\d+\]/g, '') // Remove citation numbers like [1]
                .replace(/Source:.*$/gm, '') // Remove "Source:" lines
                .replace(/Learn more:.*$/gm, '') // Remove "Learn more:" lines
                .replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '') // Remove emojis
                .replace(/\s+/g, ' ') // Clean up extra spaces
                .trim();
        }

        async function speakText(text) {
            if (isMuted) return;

            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const cleanText = cleanTextForSpeech(text);
            if (!cleanText) return;

            const apiKey = localStorage.getItem('openaiApiKey');

            // Use OpenAI TTS if API key is available
            if (apiKey) {
                try {
                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            voice: 'shimmer', // Friendly, expressive voice great for kids
                            input: cleanText,
                            speed: 1.0
                        })
                    });

                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        currentAudio = new Audio(audioUrl);
                        currentAudio.play();
                        currentAudio.onended = () => URL.revokeObjectURL(audioUrl);
                        return;
                    }
                } catch (error) {
                    console.log('OpenAI TTS error, falling back to browser:', error);
                }
            }

            // Fallback to browser speech synthesis
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 1.05;
                utterance.pitch = 1.5;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('curiosityMuted', isMuted);
            const muteBtn = document.getElementById('muteBtn');
            muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
            muteBtn.classList.toggle('muted', isMuted);

            if (isMuted) {
                // Stop OpenAI TTS audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                // Stop browser speech
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
            }
        }

        // Initialize mute button state
        function initMuteButton() {
            const muteBtn = document.getElementById('muteBtn');
            if (muteBtn) {
                muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
                muteBtn.classList.toggle('muted', isMuted);
            }
        }

        // Cache voices when they load (they load asynchronously)
        let cachedVoices = [];

        function loadVoices() {
            cachedVoices = window.speechSynthesis.getVoices();
            console.log('Loaded voices:', cachedVoices.map(v => v.name));
        }

        if (window.speechSynthesis) {
            loadVoices(); // Try immediately
            window.speechSynthesis.onvoiceschanged = loadVoices; // And when ready
        }

        // ========== CONFETTI ANIMATION ==========
        function triggerConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);

            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3'];
            const shapes = ['square', 'circle', 'triangle'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = `confetti ${shapes[Math.floor(Math.random() * shapes.length)]}`;
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
            }

            // Clean up after animation
            setTimeout(() => container.remove(), 5000);
        }

        // ========== NAVIGATION ==========
        function goHome() {
            showScreen('welcome');
        }

        // Topic content database - defines missions for each topic
        const topicDatabase = {
            planes: {
                emoji: '‚úàÔ∏è',
                name: 'Planes',
                mission1: {
                    title: 'Build a Flying Machine',
                    description: 'Build your own plane and test it!',
                    icon: '‚úàÔ∏è',
                    buildPrompt: 'Pick parts for your plane',
                    partType1: 'wings',
                    partType2: 'nose',
                    conceptLearned: 'Wings give lift and pointy noses cut through air'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about planes!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Planes have wings to help them fly', wrong: 'Planes drive on roads to take off', correctIcon: '‚úàÔ∏è', wrongIcon: 'üöó', concept: 'Planes use runways, not roads' },
                        { correct: 'Pilots sit in the cockpit to fly the plane', wrong: 'Planes fly themselves with no pilot', correctIcon: 'üë®‚Äç‚úàÔ∏è', wrongIcon: 'ü§∑', concept: 'Pilots are trained to fly planes safely' },
                        { correct: 'Planes need fuel to fly', wrong: 'Planes run on water from clouds', correctIcon: '‚õΩ', wrongIcon: 'üíß', concept: 'Planes use special fuel called jet fuel' },
                        { correct: 'Jet engines push planes forward', wrong: 'Planes are pulled by invisible strings', correctIcon: 'üî•', wrongIcon: 'üßµ', concept: 'Engines create thrust to move planes' },
                        { correct: 'Planes can fly above the clouds', wrong: 'Planes must stay below all clouds', correctIcon: '‚òÅÔ∏è', wrongIcon: '‚õàÔ∏è', concept: 'Planes often fly very high in the sky' },
                        { correct: 'Airplane wheels fold up after takeoff', wrong: 'Airplane wheels fall off after takeoff', correctIcon: 'üõû', wrongIcon: 'üí•', concept: 'Landing gear retracts to reduce drag' },
                        { correct: 'Wings help planes stay in the air', wrong: 'Wings are just for decoration', correctIcon: 'ü¶Ö', wrongIcon: 'üé®', concept: 'Wings create lift to keep planes flying' },
                        { correct: 'Planes have lights for flying at night', wrong: 'Planes can only fly during the day', correctIcon: 'üí°', wrongIcon: 'üåô', concept: 'Planes have navigation lights for safety' },
                        { correct: 'Big planes can carry hundreds of people', wrong: 'All planes can only fit 2 people', correctIcon: 'üë•', wrongIcon: 'üë´', concept: 'Different planes have different sizes' },
                        { correct: 'Planes take off into the wind', wrong: 'Planes take off with the wind pushing from behind', correctIcon: 'üå¨Ô∏è', wrongIcon: 'üí®', concept: 'Taking off into wind helps planes lift faster' }
                    ]
                },
                mission3: {
                    title: 'Plan a Flight',
                    description: 'Choose the best plane for a job!',
                    icon: 'üó∫Ô∏è',
                    challenges: [
                        { challenge: 'You need to carry toys across the ocean!', option1: { name: 'Small Fast Plane', icon: 'üõ©Ô∏è', traits: ['Flies super fast', 'Can\'t carry much', 'Runs out of fuel quickly'] }, option2: { name: 'Big Cargo Plane', icon: '‚úàÔ∏è', traits: ['Flies slower', 'Carries lots of toys', 'Has plenty of fuel'] }, concept: 'Big planes carry more but fly slower' },
                        { challenge: 'Someone is sick and needs to get to the hospital fast!', option1: { name: 'Fast Emergency Plane', icon: 'üöÅ', traits: ['Very fast', 'Small inside', 'Gets there quickly'] }, option2: { name: 'Big Slow Plane', icon: '‚úàÔ∏è', traits: ['Lots of room', 'Takes a long time', 'Too slow for emergencies'] }, concept: 'Speed matters most in emergencies' },
                        { challenge: 'You want to see your city from above!', option1: { name: 'Small Sightseeing Plane', icon: 'üõ©Ô∏è', traits: ['Flies low and slow', 'Big windows', 'Great views'] }, option2: { name: 'High-Flying Jet', icon: '‚úàÔ∏è', traits: ['Flies very high', 'Small windows', 'Everything looks tiny'] }, concept: 'Flying lower lets you see more details' },
                        { challenge: 'A pilot is learning to fly for the first time!', option1: { name: 'Simple Training Plane', icon: 'üõ©Ô∏è', traits: ['Easy to control', 'Flies slowly', 'Safe for beginners'] }, option2: { name: 'Super Fast Jet', icon: 'üõ´', traits: ['Very complicated', 'Extremely fast', 'Hard to control'] }, concept: 'Beginners need simple, slow planes to learn' },
                        { challenge: 'You need to put out a forest fire from the sky!', option1: { name: 'Tiny Plane', icon: 'üõ©Ô∏è', traits: ['Very small', 'Carries little water', 'Too small to help'] }, option2: { name: 'Water Bomber Plane', icon: '‚úàÔ∏è', traits: ['Holds lots of water', 'Drops water on fires', 'Built for firefighting'] }, concept: 'Fighting fires needs planes that carry lots of water' },
                        { challenge: 'Mail needs to go to a small mountain village!', option1: { name: 'Small Bush Plane', icon: 'üõ©Ô∏è', traits: ['Lands on short runways', 'Goes to remote places', 'Perfect for mountains'] }, option2: { name: 'Giant Airliner', icon: '‚úàÔ∏è', traits: ['Needs long runways', 'Can\'t land in mountains', 'Too big'] }, concept: 'Small places need small planes' },
                        { challenge: 'Scientists want to study clouds up close!', option1: { name: 'Weather Research Plane', icon: 'üõ©Ô∏è', traits: ['Special instruments', 'Flies through clouds', 'Collects data'] }, option2: { name: 'Regular Passenger Plane', icon: '‚úàÔ∏è', traits: ['Avoids bad weather', 'No science tools', 'Just carries people'] }, concept: 'Scientists need special planes with instruments' },
                        { challenge: 'Skywriters want to draw pictures in the sky!', option1: { name: 'Skywriting Plane', icon: 'üõ©Ô∏è', traits: ['Makes smoke trails', 'Flies loops and turns', 'Draws in the sky'] }, option2: { name: 'Big Jet', icon: '‚úàÔ∏è', traits: ['Flies in straight lines', 'No smoke machine', 'Can\'t do tricks'] }, concept: 'Skywriting needs small planes that can do tricks' },
                        { challenge: 'Farmers need to spray crops in their fields!', option1: { name: 'Crop Duster Plane', icon: 'üõ©Ô∏è', traits: ['Flies very low', 'Has spray tanks', 'Made for farms'] }, option2: { name: 'High-Flying Jet', icon: '‚úàÔ∏è', traits: ['Flies too high', 'No spray equipment', 'Wrong for farming'] }, concept: 'Farm planes fly low and have special spray equipment' },
                        { challenge: 'You want to travel around the whole world!', option1: { name: 'Short-Range Plane', icon: 'üõ©Ô∏è', traits: ['Small fuel tank', 'Stops many times', 'Takes forever'] }, option2: { name: 'Long-Range Jet', icon: '‚úàÔ∏è', traits: ['Huge fuel tank', 'Flies very far', 'Fewer stops needed'] }, concept: 'Long trips need planes with big fuel tanks' }
                    ]
                }
            },
            stars: {
                emoji: '‚≠ê',
                name: 'Stars',
                mission1: {
                    title: 'Build a Telescope',
                    description: 'Build a telescope to see stars!',
                    icon: 'üî≠',
                    buildPrompt: 'Pick parts for your telescope',
                    partType1: 'lens',
                    partType2: 'length',
                    conceptLearned: 'Bigger lenses and longer tubes help see farther'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about stars!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Stars are very far away from Earth', wrong: 'You can touch stars with your hand', correctIcon: '‚≠ê', wrongIcon: '‚úã', concept: 'Stars are far away and very hot' },
                        { correct: 'The Sun is a star', wrong: 'The Sun is a planet', correctIcon: '‚òÄÔ∏è', wrongIcon: 'ü™ê', concept: 'Our Sun is actually a medium-sized star' },
                        { correct: 'Stars look tiny because they are far away', wrong: 'Stars are actually smaller than apples', correctIcon: 'üî≠', wrongIcon: 'üçé', concept: 'Stars are huge but look small from far away' },
                        { correct: 'Stars make their own light', wrong: 'Stars reflect light from the Moon', correctIcon: 'üí°', wrongIcon: 'üåô', concept: 'Stars glow because they are very hot' },
                        { correct: 'There are billions of stars in the sky', wrong: 'There are only 100 stars total', correctIcon: '‚ú®', wrongIcon: 'üíØ', concept: 'The universe has more stars than we can count' },
                        { correct: 'Stars can be different colors', wrong: 'All stars are yellow', correctIcon: 'üåà', wrongIcon: 'üü°', concept: 'Star colors depend on how hot they are' },
                        { correct: 'Some stars are bigger than our Sun', wrong: 'Our Sun is the biggest star ever', correctIcon: 'üåü', wrongIcon: '‚òÄÔ∏è', concept: 'Some stars are giants, much bigger than the Sun' },
                        { correct: 'Stars twinkle because of Earths air', wrong: 'Stars twinkle because they are blinking', correctIcon: 'üå¨Ô∏è', wrongIcon: 'üëÅÔ∏è', concept: 'Air makes starlight wiggle and twinkle' },
                        { correct: 'We see old light from distant stars', wrong: 'We see stars exactly as they are right now', correctIcon: '‚è∞', wrongIcon: 'üì∏', concept: 'Light from stars takes years to reach us' },
                        { correct: 'Groups of stars make patterns called constellations', wrong: 'Stars move around randomly every night', correctIcon: '‚≠ê', wrongIcon: 'üé≤', concept: 'People named star patterns long ago' }
                    ]
                },
                mission3: {
                    title: 'Plan Stargazing',
                    description: 'Make the best choice for seeing stars!',
                    icon: 'üåô',
                    challenges: [
                        { challenge: 'You want to see lots of stars tonight!', option1: { name: 'Look at Noon', icon: '‚òÄÔ∏è', traits: ['Very bright outside', 'Sun is shining', 'Can\'t see stars'] }, option2: { name: 'Look at Night', icon: 'üåô', traits: ['Dark outside', 'No sunlight', 'Stars are visible'] }, concept: 'Stars are best seen when it\'s dark outside' },
                        { challenge: 'You want to see stars clearly!', option1: { name: 'Stay in the Bright City', icon: 'üèôÔ∏è', traits: ['Lots of streetlights', 'Light pollution', 'Hard to see stars'] }, option2: { name: 'Go to the Countryside', icon: 'üèïÔ∏è', traits: ['Very dark', 'No city lights', 'Stars shine bright'] }, concept: 'City lights make it hard to see stars' },
                        { challenge: 'You want to look at the Moon up close!', option1: { name: 'Use Your Eyes Only', icon: 'üëÄ', traits: ['Moon looks small', 'Can\'t see details', 'No magnification'] }, option2: { name: 'Use a Telescope', icon: 'üî≠', traits: ['Moon looks big', 'See craters', 'Amazing details'] }, concept: 'Telescopes help us see space objects up close' },
                        { challenge: 'It\'s cloudy tonight but you want to see stars!', option1: { name: 'Wait for Clear Skies', icon: '‚è∞', traits: ['Be patient', 'Clouds will pass', 'Stars will appear'] }, option2: { name: 'Look Through Clouds', icon: '‚òÅÔ∏è', traits: ['Clouds block light', 'Can\'t see through', 'Won\'t work'] }, concept: 'Clouds block our view of the stars' },
                        { challenge: 'You want to find a specific constellation!', option1: { name: 'Use a Star Map', icon: 'üó∫Ô∏è', traits: ['Shows star positions', 'Helps you navigate', 'Find constellations'] }, option2: { name: 'Look Randomly', icon: 'üé≤', traits: ['No guidance', 'Might get lost', 'Hard to find'] }, concept: 'Star maps help us find constellations' },
                        { challenge: 'You want to take photos of stars!', option1: { name: 'Quick Snapshot', icon: 'üì∏', traits: ['Too fast', 'Stars too dim', 'Dark photo'] }, option2: { name: 'Long Exposure Camera', icon: 'üì∑', traits: ['Collects more light', 'Stars appear bright', 'Beautiful photos'] }, concept: 'Cameras need time to capture dim starlight' },
                        { challenge: 'You want to see a meteor shower!', option1: { name: 'Check the Schedule', icon: 'üìÖ', traits: ['Know when it happens', 'Be prepared', 'Don\'t miss it'] }, option2: { name: 'Hope to Get Lucky', icon: 'üçÄ', traits: ['Might miss it', 'No planning', 'Probably won\'t see'] }, concept: 'Meteor showers happen at predictable times' },
                        { challenge: 'Your eyes need to adjust to see faint stars!', option1: { name: 'Keep Looking at Phone', icon: 'üì±', traits: ['Bright screen', 'Ruins night vision', 'Can\'t see dim stars'] }, option2: { name: 'Let Eyes Adjust in Dark', icon: 'üëÅÔ∏è', traits: ['Takes 20 minutes', 'Eyes get sensitive', 'See more stars'] }, concept: 'Our eyes need time to adjust to darkness' },
                        { challenge: 'You want to learn what stars you\'re seeing!', option1: { name: 'Use a Stargazing App', icon: 'üì±', traits: ['Names the stars', 'Shows information', 'Great for learning'] }, option2: { name: 'Make Up Names', icon: 'ü§î', traits: ['Fun but not real', 'Won\'t learn facts', 'Just guessing'] }, concept: 'Apps can teach us real star names' },
                        { challenge: 'You want to see the Milky Way galaxy!', option1: { name: 'Very Dark Location', icon: 'üèîÔ∏è', traits: ['Far from cities', 'Super dark', 'Milky Way visible'] }, option2: { name: 'Your Backyard in City', icon: 'üè†', traits: ['Too much light', 'Can\'t see it', 'Too bright'] }, concept: 'The Milky Way needs very dark skies to see' }
                    ]
                }
            },
            dinosaurs: {
                emoji: 'ü¶ï',
                name: 'Dinosaurs',
                mission1: {
                    title: 'Build a Dinosaur',
                    description: 'Design your own dinosaur!',
                    icon: 'ü¶ï',
                    buildPrompt: 'Pick parts for your dinosaur',
                    partType1: 'size',
                    partType2: 'teeth',
                    conceptLearned: 'Dinosaurs had different sizes and teeth for different foods'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about dinosaurs!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Dinosaurs lived millions of years ago', wrong: 'Dinosaurs live in the zoo today', correctIcon: 'ü¶¥', wrongIcon: 'ü¶Å', concept: 'Dinosaurs are extinct and lived long ago' },
                        { correct: 'We learn about dinosaurs from fossils', wrong: 'We learn about dinosaurs from videos of them', correctIcon: 'ü¶¥', wrongIcon: 'üìπ', concept: 'Fossils are preserved bones from long ago' },
                        { correct: 'Some dinosaurs ate only plants', wrong: 'All dinosaurs ate meat', correctIcon: 'üåø', wrongIcon: 'ü•©', concept: 'Dinosaurs had different diets like animals today' },
                        { correct: 'T-Rex had tiny arms', wrong: 'T-Rex had super long arms', correctIcon: 'ü¶ñ', wrongIcon: 'ü¶ß', concept: 'T-Rex arms were small compared to its body' },
                        { correct: 'Some dinosaurs had feathers', wrong: 'No dinosaur ever had feathers', correctIcon: 'ü™∂', wrongIcon: 'ü¶é', concept: 'Scientists found fossils showing feathered dinosaurs' },
                        { correct: 'Dinosaurs hatched from eggs', wrong: 'Dinosaurs were born like puppies', correctIcon: 'ü•ö', wrongIcon: 'üêï', concept: 'Dinosaurs laid eggs like birds and reptiles' },
                        { correct: 'Birds are related to dinosaurs', wrong: 'Birds and dinosaurs are not related at all', correctIcon: 'üê¶', wrongIcon: '‚ùå', concept: 'Birds evolved from small dinosaurs' },
                        { correct: 'Some dinosaurs were as small as chickens', wrong: 'All dinosaurs were bigger than houses', correctIcon: 'üêî', wrongIcon: 'üè†', concept: 'Dinosaurs came in many different sizes' },
                        { correct: 'Dinosaurs lived on land', wrong: 'Most dinosaurs lived underwater', correctIcon: 'üèúÔ∏è', wrongIcon: 'üåä', concept: 'Dinosaurs were land animals' },
                        { correct: 'A big asteroid helped end the dinosaurs', wrong: 'Dinosaurs just decided to leave Earth', correctIcon: '‚òÑÔ∏è', wrongIcon: 'üöÄ', concept: 'A giant space rock changed Earths climate' }
                    ]
                },
                mission3: {
                    title: 'Dinosaur Decisions',
                    description: 'Make smart choices about dinosaurs!',
                    icon: '‚õèÔ∏è',
                    challenges: [
                        { challenge: 'You want to find dinosaur bones!', option1: { name: 'Dig in Your Backyard', icon: 'üè°', traits: ['Easy to dig', 'Dirt is soft', 'No fossils there'] }, option2: { name: 'Dig Where Scientists Found Some', icon: 'üèúÔ∏è', traits: ['Hard to get to', 'Special rocky places', 'Fossils are there'] }, concept: 'Fossils are found in special rocky places' },
                        { challenge: 'You found a dinosaur bone! How do you dig it out?', option1: { name: 'Use Gentle Brushes', icon: 'üñåÔ∏è', traits: ['Very careful', 'Won\'t break bone', 'Takes time'] }, option2: { name: 'Use a Big Shovel', icon: 'ü™ì', traits: ['Too rough', 'Might break it', 'Not careful enough'] }, concept: 'Fossils are fragile and need gentle tools' },
                        { challenge: 'You want to learn what a dinosaur looked like!', option1: { name: 'Look at Bones Only', icon: 'ü¶¥', traits: ['Just the skeleton', 'No skin or color', 'Missing details'] }, option2: { name: 'Study Bones Plus Clues', icon: 'üîç', traits: ['Look at relatives', 'Study the environment', 'Make smart guesses'] }, concept: 'Scientists use many clues to imagine how dinosaurs looked' },
                        { challenge: 'You want to know what a T-Rex ate!', option1: { name: 'Look at Its Teeth', icon: 'ü¶∑', traits: ['Sharp teeth = meat eater', 'Tells us about diet', 'Good evidence'] }, option2: { name: 'Just Guess Randomly', icon: 'üé≤', traits: ['No evidence', 'Might be wrong', 'Not scientific'] }, concept: 'Dinosaur teeth tell us what they ate' },
                        { challenge: 'A dinosaur fossil is very heavy! How do you move it?', option1: { name: 'Wrap in Plaster Cast', icon: 'ü©π', traits: ['Protects the fossil', 'Safe to move', 'Scientists do this'] }, option2: { name: 'Just Carry It', icon: 'üí™', traits: ['Too heavy', 'Might drop it', 'Could break'] }, concept: 'Plaster casts protect fossils when moving them' },
                        { challenge: 'You want to know how big a dinosaur was!', option1: { name: 'Measure the Bones', icon: 'üìè', traits: ['Accurate size', 'Scientific method', 'Real data'] }, option2: { name: 'Imagine Any Size', icon: 'üí≠', traits: ['Just made up', 'Probably wrong', 'No proof'] }, concept: 'Measuring bones tells us how big dinosaurs really were' },
                        { challenge: 'You want to know how fast dinosaurs could run!', option1: { name: 'Study Leg Bones and Footprints', icon: 'ü¶∂', traits: ['Shows stride length', 'Leg size matters', 'Real clues'] }, option2: { name: 'Make Up a Speed', icon: 'üèÉ', traits: ['No evidence', 'Just guessing', 'Not scientific'] }, concept: 'Footprints and legs tell us about dinosaur speed' },
                        { challenge: 'You found two fossil bones. Are they from the same dinosaur?', option1: { name: 'Check If They Fit Together', icon: 'üß©', traits: ['See if they match', 'Check the size', 'Look at location'] }, option2: { name: 'Assume They Match', icon: 'üëç', traits: ['No checking', 'Could be wrong', 'Sloppy science'] }, concept: 'Scientists carefully match bones that belong together' },
                        { challenge: 'You want to know if dinosaurs were warm or cold blooded!', option1: { name: 'Study Growth Rings in Bones', icon: 'üî¨', traits: ['Bones have clues', 'Shows how they grew', 'Scientific evidence'] }, option2: { name: 'Just Pick One', icon: 'ü§∑', traits: ['No evidence', 'Random guess', 'Not helpful'] }, concept: 'Bones can tell us about dinosaur body temperature' },
                        { challenge: 'A museum wants to display a dinosaur skeleton!', option1: { name: 'Use a Copy Made of Plastic', icon: 'üèõÔ∏è', traits: ['Protects real fossil', 'Can be touched', 'Real one stays safe'] }, option2: { name: 'Use the Real Bones', icon: 'ü¶¥', traits: ['Could get damaged', 'Very fragile', 'Risky to display'] }, concept: 'Museums often display copies to protect real fossils' }
                    ]
                }
            },
            ocean: {
                emoji: 'üåä',
                name: 'Ocean',
                mission1: {
                    title: 'Build a Submarine',
                    description: 'Build a submarine to explore!',
                    icon: 'üö¢',
                    buildPrompt: 'Pick parts for your submarine',
                    partType1: 'hull',
                    partType2: 'windows',
                    conceptLearned: 'Strong hulls and thick windows help submarines go deep'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about oceans!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Fish can breathe underwater using gills', wrong: 'Fish wear tiny scuba tanks to breathe', correctIcon: 'üêü', wrongIcon: 'ü§ø', concept: 'Fish use gills to breathe underwater' },
                        { correct: 'The ocean is salty', wrong: 'The ocean tastes like lemonade', correctIcon: 'üßÇ', wrongIcon: 'üçã', concept: 'Ocean water has salt dissolved in it' },
                        { correct: 'Whales are mammals, not fish', wrong: 'Whales are the biggest fish', correctIcon: 'üêã', wrongIcon: 'üêü', concept: 'Whales breathe air and feed milk to babies' },
                        { correct: 'Octopuses have eight arms', wrong: 'Octopuses have two arms like people', correctIcon: 'üêô', wrongIcon: 'üí™', concept: 'Octo means eight in Latin' },
                        { correct: 'The deep ocean is very dark', wrong: 'The deep ocean has streetlights', correctIcon: 'üåë', wrongIcon: 'üí°', concept: 'Sunlight cannot reach the deep ocean' },
                        { correct: 'Dolphins are very smart animals', wrong: 'Dolphins are robots made by scientists', correctIcon: 'üê¨', wrongIcon: 'ü§ñ', concept: 'Dolphins can learn tricks and communicate' },
                        { correct: 'Coral reefs are home to many fish', wrong: 'Coral reefs are made of plastic', correctIcon: 'ü™∏', wrongIcon: 'üß±', concept: 'Coral is made by tiny living creatures' },
                        { correct: 'Sharks have been around for millions of years', wrong: 'Sharks were invented 50 years ago', correctIcon: 'ü¶à', wrongIcon: 'üÜï', concept: 'Sharks are older than dinosaurs' },
                        { correct: 'Jellyfish dont have brains', wrong: 'Jellyfish are the smartest ocean animals', correctIcon: 'üß†', wrongIcon: 'üéì', concept: 'Jellyfish are simple creatures without brains' },
                        { correct: 'Sea turtles can live for over 100 years', wrong: 'Sea turtles only live for 1 year', correctIcon: 'üê¢', wrongIcon: 'üìÖ', concept: 'Sea turtles are one of the longest-living animals' }
                    ]
                },
                mission3: {
                    title: 'Ocean Adventures',
                    description: 'Make smart ocean choices!',
                    icon: 'üåä',
                    challenges: [
                        { challenge: 'You want to see colorful fish!', option1: { name: 'Super Deep Dark Place', icon: 'üï≥Ô∏è', traits: ['Very deep', 'No sunlight', 'Few creatures'] }, option2: { name: 'Shallow Sunny Water', icon: '‚òÄÔ∏è', traits: ['Not too deep', 'Lots of sunlight', 'Colorful fish'] }, concept: 'Colorful fish live where there is sunlight' },
                        { challenge: 'You want to see a whale up close!', option1: { name: 'Swim Right Up To It', icon: 'üèä', traits: ['Dangerous', 'Might scare it', 'Not safe'] }, option2: { name: 'Watch From a Boat', icon: 'üö§', traits: ['Safe distance', 'Don\'t disturb whale', 'Better for everyone'] }, concept: 'We should watch whales from a safe distance' },
                        { challenge: 'You found a pretty seashell with something inside!', option1: { name: 'Leave It Alone', icon: 'üëã', traits: ['Animal lives there', 'Don\'t disturb it', 'Kind choice'] }, option2: { name: 'Take It Home', icon: 'üè†', traits: ['Takes animal\'s home', 'Could hurt it', 'Not nice'] }, concept: 'Seashells are homes for ocean creatures' },
                        { challenge: 'You want to explore a coral reef!', option1: { name: 'Touch Everything', icon: '‚úã', traits: ['Damages coral', 'Coral is fragile', 'Hurts the reef'] }, option2: { name: 'Look But Don\'t Touch', icon: 'üëÄ', traits: ['Keeps coral safe', 'Respectful', 'Reef stays healthy'] }, concept: 'Coral is alive and fragile - look but don\'t touch' },
                        { challenge: 'You see trash floating in the ocean!', option1: { name: 'Leave It There', icon: 'üö∂', traits: ['Hurts animals', 'Pollutes water', 'Makes ocean dirty'] }, option2: { name: 'Pick It Up Safely', icon: 'üß§', traits: ['Helps ocean', 'Protects animals', 'Good choice'] }, concept: 'Picking up trash helps keep oceans clean' },
                        { challenge: 'You want to learn about deep sea creatures!', option1: { name: 'Read Books and Watch Videos', icon: 'üìö', traits: ['Safe way to learn', 'Lots of information', 'See amazing creatures'] }, option2: { name: 'Dive Super Deep Yourself', icon: 'ü§ø', traits: ['Too dangerous', 'Need special submarine', 'Not possible alone'] }, concept: 'We learn about the deep sea through science and videos' },
                        { challenge: 'A sea turtle is tangled in a fishing net!', option1: { name: 'Call Wildlife Rescue', icon: 'üìû', traits: ['Experts can help', 'Safe for turtle', 'Right thing to do'] }, option2: { name: 'Ignore It', icon: 'üôà', traits: ['Turtle might die', 'Needs help', 'Not kind'] }, concept: 'Wildlife rescuers know how to help sea animals' },
                        { challenge: 'You want to swim with dolphins!', option1: { name: 'Join a Safe Tour', icon: 'üé´', traits: ['Trained guides', 'Rules to follow', 'Safe for everyone'] }, option2: { name: 'Chase Wild Dolphins', icon: 'üèÉ', traits: ['Scares dolphins', 'Could be dangerous', 'Not respectful'] }, concept: 'Safe tours let us see dolphins without scaring them' },
                        { challenge: 'You\'re at the beach and see a jellyfish!', option1: { name: 'Stay Away From It', icon: '‚õî', traits: ['Some can sting', 'Better to be safe', 'Smart choice'] }, option2: { name: 'Poke It With a Stick', icon: 'ü™µ', traits: ['Might sting you', 'Hurts jellyfish', 'Not safe'] }, concept: 'Jellyfish can sting - it\'s best to stay away' },
                        { challenge: 'You want to help protect the ocean!', option1: { name: 'Use Less Plastic', icon: '‚ôªÔ∏è', traits: ['Less trash in ocean', 'Helps sea animals', 'Good for Earth'] }, option2: { name: 'Do Nothing', icon: 'ü§∑', traits: ['Ocean gets dirtier', 'Animals suffer', 'Not helpful'] }, concept: 'Using less plastic helps keep oceans clean' }
                    ]
                }
            },
            robots: {
                emoji: 'ü§ñ',
                name: 'Robots',
                mission1: {
                    title: 'Build a Robot',
                    description: 'Design your own robot helper!',
                    icon: 'ü§ñ',
                    buildPrompt: 'Pick parts for your robot',
                    partType1: 'arms',
                    partType2: 'wheels',
                    conceptLearned: 'Different robot parts help with different tasks'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about robots!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Robots follow instructions from people', wrong: 'Robots can think all by themselves', correctIcon: 'üíª', wrongIcon: 'üß†', concept: 'Robots need instructions called programs' },
                        { correct: 'Robots need electricity to work', wrong: 'Robots eat food like humans do', correctIcon: 'üîå', wrongIcon: 'üçï', concept: 'Robots run on batteries or electricity' },
                        { correct: 'People build and program robots', wrong: 'Robots grow from robot seeds', correctIcon: 'üë®‚Äçüîß', wrongIcon: 'üå±', concept: 'Engineers and programmers create robots' },
                        { correct: 'Robots can help doctors do surgery', wrong: 'Robots go to school to become doctors', correctIcon: 'üè•', wrongIcon: 'üéí', concept: 'Robots are tools that help human doctors' },
                        { correct: 'Some robots can vacuum floors', wrong: 'Robots are too proud to clean', correctIcon: 'üßπ', wrongIcon: 'üëë', concept: 'Robot vacuums help keep homes clean' },
                        { correct: 'Robots dont have feelings', wrong: 'Robots get sad when you turn them off', correctIcon: 'üòê', wrongIcon: 'üò¢', concept: 'Robots are machines without emotions' },
                        { correct: 'Robots can work in dangerous places', wrong: 'Robots are scared of the dark', correctIcon: '‚ò¢Ô∏è', wrongIcon: 'üò®', concept: 'Robots can go where humans cannot' },
                        { correct: 'Some robots look like arms in factories', wrong: 'All robots look like metal humans', correctIcon: 'ü¶æ', wrongIcon: 'üö∂', concept: 'Robots come in many shapes and sizes' },
                        { correct: 'Robots do exactly what they are programmed to do', wrong: 'Robots make up their own rules', correctIcon: 'üìã', wrongIcon: 'üé≤', concept: 'Robots follow code written by people' },
                        { correct: 'Mars rovers are robots exploring another planet', wrong: 'Robots refuse to travel to space', correctIcon: 'üî¥', wrongIcon: 'üö´', concept: 'Robot explorers help us learn about Mars' }
                    ]
                },
                mission3: {
                    title: 'Robot Challenges',
                    description: 'Pick the right robot for the job!',
                    icon: '‚öôÔ∏è',
                    challenges: [
                        { challenge: 'You need to carry heavy boxes!', option1: { name: 'Tiny Robot', icon: 'ü§è', traits: ['Very small', 'Can\'t lift much', 'Good for small tasks'] }, option2: { name: 'Strong Robot', icon: 'üí™', traits: ['Big and strong', 'Can lift heavy things', 'Perfect for boxes'] }, concept: 'Big jobs need big strong robots' },
                        { challenge: 'You need a robot to vacuum your house!', option1: { name: 'Round Vacuum Robot', icon: 'üîµ', traits: ['Fits under furniture', 'Cleans floors', 'Made for vacuuming'] }, option2: { name: 'Giant Factory Robot', icon: 'üè≠', traits: ['Way too big', 'Can\'t fit in house', 'Wrong for cleaning'] }, concept: 'Home robots need to be the right size for homes' },
                        { challenge: 'A robot needs to explore a volcano!', option1: { name: 'Robot Made of Ice', icon: 'üßä', traits: ['Would melt', 'Can\'t handle heat', 'Bad choice'] }, option2: { name: 'Heat-Resistant Robot', icon: 'üî•', traits: ['Survives heat', 'Special materials', 'Built for volcanoes'] }, concept: 'Robots for hot places need heat protection' },
                        { challenge: 'You want a robot to paint a picture!', option1: { name: 'Robot with Precise Arm', icon: 'ü¶æ', traits: ['Careful movements', 'Holds brush well', 'Good for art'] }, option2: { name: 'Robot Bulldozer', icon: 'üöú', traits: ['Too big', 'Not precise', 'Would make a mess'] }, concept: 'Art robots need precise, careful movements' },
                        { challenge: 'A robot needs to swim underwater!', option1: { name: 'Waterproof Robot', icon: 'ü§ø', traits: ['Sealed tight', 'Can swim', 'Works underwater'] }, option2: { name: 'Regular Robot', icon: 'ü§ñ', traits: ['Water gets inside', 'Breaks down', 'Not waterproof'] }, concept: 'Underwater robots must be waterproof' },
                        { challenge: 'You want a robot to help find people after an earthquake!', option1: { name: 'Small Rescue Robot', icon: 'üîç', traits: ['Fits in small spaces', 'Has cameras', 'Finds trapped people'] }, option2: { name: 'Giant Walking Robot', icon: 'ü¶ø', traits: ['Too big for rubble', 'Might cause more damage', 'Can\'t fit'] }, concept: 'Rescue robots need to fit in tight spaces' },
                        { challenge: 'A robot needs to work in the dark!', option1: { name: 'Robot with Lights and Sensors', icon: 'üí°', traits: ['Has flashlights', 'Uses sensors', 'Sees in the dark'] }, option2: { name: 'Robot with Only Eyes', icon: 'üëÄ', traits: ['Needs light to see', 'Can\'t work in dark', 'Would be blind'] }, concept: 'Dark-working robots need lights and special sensors' },
                        { challenge: 'You want a robot to deliver packages!', option1: { name: 'Delivery Robot with Wheels', icon: 'üì¶', traits: ['Carries packages', 'Rolls on sidewalk', 'Made for delivery'] }, option2: { name: 'Robot Hand Only', icon: 'üñêÔ∏è', traits: ['Can\'t move around', 'Stays in one place', 'Can\'t deliver'] }, concept: 'Delivery robots need to move from place to place' },
                        { challenge: 'A robot needs to work with people safely!', option1: { name: 'Soft Gentle Robot', icon: 'üß∏', traits: ['Soft edges', 'Moves slowly', 'Won\'t hurt anyone'] }, option2: { name: 'Fast Sharp Robot', icon: '‚öîÔ∏è', traits: ['Sharp parts', 'Moves fast', 'Could be dangerous'] }, concept: 'Robots near people should be soft and gentle' },
                        { challenge: 'You want a robot to sort tiny computer chips!', option1: { name: 'Super Precise Mini Robot', icon: 'üî¨', traits: ['Tiny movements', 'Very accurate', 'Handles small parts'] }, option2: { name: 'Big Clumsy Robot', icon: 'ü§ñ', traits: ['Movements too big', 'Would break chips', 'Not precise enough'] }, concept: 'Tiny jobs need precise mini robots' }
                    ]
                }
            },
            space: {
                emoji: 'üöÄ',
                name: 'Space',
                mission1: {
                    title: 'Build a Rocket',
                    description: 'Build a rocket to go to space!',
                    icon: 'üöÄ',
                    buildPrompt: 'Pick parts for your rocket',
                    partType1: 'engines',
                    partType2: 'fuel tank',
                    conceptLearned: 'Powerful engines and lots of fuel help rockets reach space'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find the wrong fact about space!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'There is no air to breathe in space', wrong: 'You can breathe normally in space', correctIcon: 'üåå', wrongIcon: 'üòÆ', concept: 'Astronauts need spacesuits because theres no air' },
                        { correct: 'The Moon orbits around Earth', wrong: 'The Moon is glued to the sky', correctIcon: 'üåô', wrongIcon: 'üß≤', concept: 'The Moon travels in a path around our planet' },
                        { correct: 'Astronauts float in space', wrong: 'Astronauts walk normally in space', correctIcon: 'üßë‚ÄçüöÄ', wrongIcon: 'üö∂', concept: 'There is very little gravity in space' },
                        { correct: 'Space is very cold and dark', wrong: 'Space is warm and sunny everywhere', correctIcon: 'ü•∂', wrongIcon: '‚òÄÔ∏è', concept: 'Space has no air to hold heat or scatter light' },
                        { correct: 'Rockets need lots of fuel to escape Earth', wrong: 'Rockets float up like balloons', correctIcon: '‚õΩ', wrongIcon: 'üéà', concept: 'Rockets must push hard against gravity' },
                        { correct: 'The Sun is much bigger than Earth', wrong: 'Earth is bigger than the Sun', correctIcon: '‚òÄÔ∏è', wrongIcon: 'üåç', concept: 'The Sun is huge - a million Earths could fit inside' },
                        { correct: 'There are 8 planets in our solar system', wrong: 'There are 100 planets in our solar system', correctIcon: 'ü™ê', wrongIcon: 'üíØ', concept: 'Mercury, Venus, Earth, Mars, Jupiter, Saturn, Uranus, Neptune' },
                        { correct: 'It takes light from the Sun 8 minutes to reach Earth', wrong: 'Sunlight reaches Earth instantly', correctIcon: '‚è±Ô∏è', wrongIcon: '‚ö°', concept: 'Even light takes time to travel through space' },
                        { correct: 'Saturn has beautiful rings made of ice and rock', wrong: 'Saturns rings are made of rainbows', correctIcon: 'üíç', wrongIcon: 'üåà', concept: 'Saturns rings are bits of ice and rock orbiting the planet' },
                        { correct: 'Astronauts train for years before going to space', wrong: 'Anyone can go to space tomorrow', correctIcon: 'üéì', wrongIcon: 'üé´', concept: 'Space travel requires lots of preparation' }
                    ]
                },
                mission3: {
                    title: 'Space Missions',
                    description: 'Make smart space choices!',
                    icon: 'üåô',
                    challenges: [
                        { challenge: 'You\'re going to the Moon for a week!', option1: { name: 'Just a Sandwich', icon: 'ü•™', traits: ['Light to carry', 'Runs out fast', 'Not enough'] }, option2: { name: 'Food, Water, and Air', icon: 'üì¶', traits: ['Heavier', 'Lasts all week', 'Everything you need'] }, concept: 'Space trips need careful planning for supplies' },
                        { challenge: 'You want to walk on the Moon!', option1: { name: 'Wear Regular Clothes', icon: 'üëï', traits: ['No air to breathe', 'Too cold', 'Very dangerous'] }, option2: { name: 'Wear a Spacesuit', icon: 'üßë‚ÄçüöÄ', traits: ['Has oxygen', 'Keeps you warm', 'Protects you'] }, concept: 'Spacesuits protect astronauts from space' },
                        { challenge: 'Your spaceship is running low on fuel!', option1: { name: 'Keep Going Full Speed', icon: 'üöÄ', traits: ['Uses more fuel', 'Might run out', 'Risky choice'] }, option2: { name: 'Slow Down to Save Fuel', icon: 'üê¢', traits: ['Uses less fuel', 'Safer choice', 'Good planning'] }, concept: 'Managing fuel is important in space' },
                        { challenge: 'You want to talk to Earth from the Moon!', option1: { name: 'Use a Radio', icon: 'üìª', traits: ['Radio waves work in space', 'Can reach Earth', 'How astronauts communicate'] }, option2: { name: 'Just Yell Really Loud', icon: 'üì¢', traits: ['Sound can\'t travel in space', 'No air to carry sound', 'Won\'t work'] }, concept: 'Sound needs air - radios work in space' },
                        { challenge: 'Something breaks on the space station!', option1: { name: 'Wait for Help from Earth', icon: '‚è≥', traits: ['Takes too long', 'Could be dangerous', 'Not always possible'] }, option2: { name: 'Fix It Yourself with Training', icon: 'üîß', traits: ['Astronauts learn repairs', 'Faster solution', 'Important skill'] }, concept: 'Astronauts must know how to fix things in space' },
                        { challenge: 'You want to grow food in space!', option1: { name: 'Plant Seeds in Special Containers', icon: 'üå±', traits: ['Plants can grow', 'Need special lights', 'Astronauts do this'] }, option2: { name: 'Throw Seeds in the Air', icon: 'üéØ', traits: ['Seeds float away', 'No soil', 'Won\'t grow'] }, concept: 'Growing food in space needs special equipment' },
                        { challenge: 'You need to exercise in space!', option1: { name: 'Skip Exercise', icon: 'üõãÔ∏è', traits: ['Muscles get weak', 'Bones get weak', 'Bad for health'] }, option2: { name: 'Use Special Exercise Machines', icon: 'üèãÔ∏è', traits: ['Keeps muscles strong', 'Astronauts do this daily', 'Very important'] }, concept: 'Astronauts must exercise to stay healthy in space' },
                        { challenge: 'A meteor is heading toward your spaceship!', option1: { name: 'Stay in the Same Spot', icon: 'üéØ', traits: ['Might get hit', 'Very dangerous', 'Bad choice'] }, option2: { name: 'Move Out of the Way', icon: '‚Ü©Ô∏è', traits: ['Avoid the meteor', 'Stay safe', 'Smart choice'] }, concept: 'Spaceships can move to avoid space dangers' },
                        { challenge: 'You want to land on Mars!', option1: { name: 'Land Really Fast', icon: 'üí®', traits: ['Too fast', 'Would crash', 'Very dangerous'] }, option2: { name: 'Use Parachutes and Rockets to Slow Down', icon: 'ü™Ç', traits: ['Slows you down', 'Safe landing', 'How rovers land'] }, concept: 'Landing on planets requires slowing down carefully' },
                        { challenge: 'You want to bring a pet to space!', option1: { name: 'Bring Any Pet', icon: 'üêï', traits: ['Hard to care for', 'Might float around', 'Complicated'] }, option2: { name: 'Learn About Space Animals First', icon: 'üìö', traits: ['Some animals went to space', 'Need special care', 'Scientists study this'] }, concept: 'Taking care of animals in space is very complicated' }
                    ]
                }
            },
            // Generic fallback - will be dynamically customized for any topic
            generic: {
                emoji: 'üî¨',
                name: 'Explorer',
                mission1: {
                    title: 'Design & Test',
                    description: 'Create and test your ideas!',
                    icon: 'üî®',
                    buildPrompt: 'Pick parts to build with',
                    partType1: 'size',
                    partType2: 'shape',
                    conceptLearned: 'Testing ideas helps us learn what works'
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: 'Find what doesn\'t make sense!',
                    icon: 'üîç',
                    facts: [
                        { correct: 'Learning new things takes practice', wrong: 'You can learn everything in one day', correctIcon: 'üìö', wrongIcon: '‚è∞', concept: 'Learning takes time and practice' },
                        { correct: 'Asking questions helps you understand', wrong: 'Questions are not allowed', correctIcon: '‚ùì', wrongIcon: 'üö´', concept: 'Curious minds ask lots of questions' },
                        { correct: 'Making mistakes helps you improve', wrong: 'You should never make mistakes', correctIcon: 'üí°', wrongIcon: 'üò∞', concept: 'Mistakes are part of learning' },
                        { correct: 'Everyone starts as a beginner', wrong: 'Experts were never beginners', correctIcon: 'üå±', wrongIcon: 'üèÜ', concept: 'Everyone starts somewhere and grows with practice' },
                        { correct: 'Trying different ways can solve problems', wrong: 'There is only one way to do anything', correctIcon: 'üîÑ', wrongIcon: '1Ô∏è‚É£', concept: 'There are often many ways to solve a problem' },
                        { correct: 'Books and experts can teach us new things', wrong: 'You can only learn by yourself', correctIcon: 'üìñ', wrongIcon: 'üôà', concept: 'We can learn from books, teachers, and experts' },
                        { correct: 'Practicing makes you better over time', wrong: 'If you can\'t do it the first time, give up', correctIcon: 'üí™', wrongIcon: 'üòû', concept: 'Practice and persistence lead to improvement' },
                        { correct: 'It\'s okay to say "I don\'t know yet"', wrong: 'You should always pretend to know everything', correctIcon: 'ü§î', wrongIcon: 'üé≠', concept: 'Admitting what we don\'t know helps us learn' },
                        { correct: 'Experiments help us discover new things', wrong: 'Experiments are a waste of time', correctIcon: 'üß™', wrongIcon: 'üö´', concept: 'Experiments teach us how things work' },
                        { correct: 'Working together can solve harder problems', wrong: 'Smart people never need help', correctIcon: 'ü§ù', wrongIcon: 'ü¶∏', concept: 'Teamwork helps solve bigger challenges' }
                    ]
                },
                mission3: {
                    title: 'Make a Choice',
                    description: 'Think about what\'s best!',
                    icon: 'ü§î',
                    challenges: [
                        { challenge: 'You want to learn something new!', option1: { name: 'Practice a Little Each Day', icon: 'üìÖ', traits: ['Steady progress', 'Remember better', 'Less stressful'] }, option2: { name: 'Try Everything at Once', icon: 'ü§Ø', traits: ['Too much at once', 'Hard to remember', 'Overwhelming'] }, concept: 'Learning a little each day works better than cramming' },
                        { challenge: 'You need to solve a tricky problem!', option1: { name: 'Think First, Then Act', icon: 'ü§î', traits: ['Plan ahead', 'Consider options', 'Make good choices'] }, option2: { name: 'Rush Into It', icon: 'üèÉ', traits: ['No planning', 'Might make mistakes', 'Could go wrong'] }, concept: 'Thinking before acting leads to better results' },
                        { challenge: 'You made a mistake on your project!', option1: { name: 'Learn From It', icon: 'üí°', traits: ['Figure out what went wrong', 'Try again', 'Get better'] }, option2: { name: 'Give Up Completely', icon: 'üòû', traits: ['Stop trying', 'Never improve', 'Miss out on learning'] }, concept: 'Mistakes are chances to learn and improve' },
                        { challenge: 'You don\'t understand something!', option1: { name: 'Ask Questions', icon: '‚ùì', traits: ['Get help', 'Learn faster', 'Understand better'] }, option2: { name: 'Pretend You Know', icon: 'üé≠', traits: ['Stay confused', 'Fall behind', 'Miss learning'] }, concept: 'Asking questions is a sign of being smart' },
                        { challenge: 'A friend has a different idea than you!', option1: { name: 'Listen and Discuss', icon: 'üëÇ', traits: ['Hear their idea', 'Share yours too', 'Maybe learn something'] }, option2: { name: 'Ignore Them', icon: 'üôâ', traits: ['Miss good ideas', 'Not friendly', 'Stay stuck'] }, concept: 'Different ideas can teach us new things' },
                        { challenge: 'You want to try something hard!', option1: { name: 'Start with Small Steps', icon: 'üë£', traits: ['Build up slowly', 'Gain confidence', 'Eventually succeed'] }, option2: { name: 'Try the Hardest Part First', icon: 'üèîÔ∏è', traits: ['Might get frustrated', 'Too difficult', 'Could give up'] }, concept: 'Breaking big challenges into small steps helps' },
                        { challenge: 'You have a great idea!', option1: { name: 'Test It Out', icon: 'üß™', traits: ['See if it works', 'Learn from results', 'Improve it'] }, option2: { name: 'Just Imagine It', icon: 'üí≠', traits: ['Never know if it works', 'Stays just an idea', 'No real learning'] }, concept: 'Testing ideas shows us what really works' },
                        { challenge: 'Something didn\'t work the way you expected!', option1: { name: 'Try a Different Way', icon: 'üîÑ', traits: ['Experiment more', 'Find what works', 'Keep learning'] }, option2: { name: 'Do the Same Thing Again', icon: 'üîÅ', traits: ['Same result', 'No progress', 'Waste of time'] }, concept: 'If something doesn\'t work, try a different approach' },
                        { challenge: 'You want to remember what you learned!', option1: { name: 'Practice and Review', icon: 'üìù', traits: ['Remember longer', 'Understand deeper', 'Build skills'] }, option2: { name: 'Just Hope You Remember', icon: 'ü§û', traits: ['Might forget', 'No reinforcement', 'Skills fade'] }, concept: 'Reviewing what we learn helps us remember' },
                        { challenge: 'You found something really interesting!', option1: { name: 'Explore and Learn More', icon: 'üîç', traits: ['Dig deeper', 'Find cool facts', 'Become an expert'] }, option2: { name: 'Ignore It', icon: 'üö∂', traits: ['Miss out', 'Stay curious forever', 'Never know'] }, concept: 'Following your curiosity leads to amazing discoveries' }
                    ]
                }
            }
        };

        // Function to generate dynamic content for custom topics
        function generateCustomTopicData(topicName) {
            const topic = topicName.toLowerCase();
            const capitalizedTopic = topicName.charAt(0).toUpperCase() + topicName.slice(1);

            return {
                emoji: 'üî¨',
                name: capitalizedTopic,
                mission1: {
                    title: `Design a ${capitalizedTopic} Project`,
                    description: `Create and test something about ${topic}!`,
                    icon: 'üî®',
                    buildPrompt: `Pick parts for your ${topic} project`,
                    partType1: 'size',
                    partType2: 'shape',
                    conceptLearned: `Testing ideas about ${topic} helps us learn what works`
                },
                mission2: {
                    title: 'Spot the Mistake',
                    description: `Find what doesn't make sense about ${topic}!`,
                    icon: 'üîç',
                    facts: [
                        { correct: `You can learn about ${topic} from books and experts`, wrong: `Nobody knows anything about ${topic}`, correctIcon: 'üìö', wrongIcon: 'ü§∑', concept: `There are many ways to learn about ${topic}` },
                        { correct: `${capitalizedTopic} can be studied and understood`, wrong: `${capitalizedTopic} is impossible to understand`, correctIcon: 'üß†', wrongIcon: '‚ùå', concept: `With curiosity and effort, we can learn about anything` },
                        { correct: `Experts study ${topic} carefully`, wrong: `Experts just guess about ${topic}`, correctIcon: 'üî¨', wrongIcon: 'üé≤', concept: 'Scientists and experts study things carefully' },
                        { correct: `There are interesting facts about ${topic}`, wrong: `${capitalizedTopic} is completely boring`, correctIcon: '‚ú®', wrongIcon: 'üò¥', concept: 'Every topic has interesting things to discover' },
                        { correct: `People have been curious about ${topic} for a long time`, wrong: `${capitalizedTopic} was just invented yesterday`, correctIcon: 'üìú', wrongIcon: 'üÜï', concept: 'Many topics have long histories of study' },
                        { correct: `You can explore ${topic} by asking questions`, wrong: `Questions about ${topic} are not allowed`, correctIcon: '‚ùì', wrongIcon: 'üö´', concept: 'Questions are the key to learning' },
                        { correct: `Learning about ${topic} takes time and practice`, wrong: `You can know everything about ${topic} instantly`, correctIcon: '‚è∞', wrongIcon: '‚ö°', concept: 'Deep learning takes time and effort' },
                        { correct: `${capitalizedTopic} connects to other things we know`, wrong: `${capitalizedTopic} has nothing to do with anything else`, correctIcon: 'üîó', wrongIcon: 'üèùÔ∏è', concept: 'Everything is connected in interesting ways' },
                        { correct: `Experiments help us learn about ${topic}`, wrong: `We should never experiment with ${topic}`, correctIcon: 'üß™', wrongIcon: '‚õî', concept: 'Experiments teach us how things work' },
                        { correct: `Different people might see ${topic} differently`, wrong: `Everyone must think the same about ${topic}`, correctIcon: 'üë•', wrongIcon: 'ü§ñ', concept: 'Different perspectives help us understand better' }
                    ]
                },
                mission3: {
                    title: `${capitalizedTopic} Choices`,
                    description: `Think about the best choice for ${topic}!`,
                    icon: 'ü§î',
                    challenges: [
                        { challenge: `You want to learn more about ${topic}!`, option1: { name: 'Read and Explore', icon: 'üìö', traits: ['Find good sources', 'Learn step by step', 'Build knowledge'] }, option2: { name: 'Make Things Up', icon: 'üí≠', traits: ['No real facts', 'Might be wrong', 'Not real learning'] }, concept: `Good sources help us learn real facts about ${topic}` },
                        { challenge: `You have a question about ${topic}!`, option1: { name: 'Research the Answer', icon: 'üîç', traits: ['Find real facts', 'Learn something new', 'Satisfy curiosity'] }, option2: { name: 'Ignore the Question', icon: 'üôà', traits: ['Stay curious', 'Never know', 'Miss learning'] }, concept: 'Researching answers helps us grow smarter' },
                        { challenge: `Someone tells you something about ${topic} that seems wrong!`, option1: { name: 'Check the Facts', icon: '‚úÖ', traits: ['Verify information', 'Think critically', 'Find the truth'] }, option2: { name: 'Believe Everything', icon: 'üò∂', traits: ['Might be tricked', 'No critical thinking', 'Could be wrong'] }, concept: 'Checking facts helps us know what\'s true' },
                        { challenge: `You want to share what you learned about ${topic}!`, option1: { name: 'Explain Clearly', icon: 'üó£Ô∏è', traits: ['Help others learn', 'Practice explaining', 'Share knowledge'] }, option2: { name: 'Keep It Secret', icon: 'ü§ê', traits: ['Others miss out', 'No discussion', 'Learning stays small'] }, concept: 'Sharing knowledge helps everyone learn' },
                        { challenge: `You find ${topic} confusing!`, option1: { name: 'Break It Into Parts', icon: 'üß©', traits: ['Easier to understand', 'Take it step by step', 'Less overwhelming'] }, option2: { name: 'Give Up', icon: 'üè≥Ô∏è', traits: ['Never understand', 'Miss out on learning', 'Stay confused'] }, concept: 'Breaking things into smaller parts makes learning easier' },
                        { challenge: `You discovered something new about ${topic}!`, option1: { name: 'Write It Down', icon: 'üìù', traits: ['Remember it', 'Can review later', 'Build notes'] }, option2: { name: 'Just Forget It', icon: 'üß†', traits: ['Might forget', 'No record', 'Lost learning'] }, concept: 'Writing things down helps us remember' },
                        { challenge: `You want to become an expert on ${topic}!`, option1: { name: 'Study Regularly', icon: 'üìÖ', traits: ['Build knowledge slowly', 'Remember better', 'Become expert over time'] }, option2: { name: 'Study Once and Stop', icon: 'üõë', traits: ['Forget quickly', 'Never master it', 'Stay beginner'] }, concept: 'Regular practice builds expertise' },
                        { challenge: `You and a friend disagree about ${topic}!`, option1: { name: 'Research Together', icon: 'ü§ù', traits: ['Find the answer', 'Learn from each other', 'Friendly discussion'] }, option2: { name: 'Argue Without Facts', icon: 'üò§', traits: ['No resolution', 'No learning', 'Hurt feelings'] }, concept: 'Looking up facts together solves disagreements' },
                        { challenge: `You want to teach someone about ${topic}!`, option1: { name: 'Use Examples', icon: 'üí°', traits: ['Easier to understand', 'More interesting', 'Better teaching'] }, option2: { name: 'Just List Facts', icon: 'üìã', traits: ['Boring', 'Hard to remember', 'Less engaging'] }, concept: 'Examples make learning more fun and memorable' },
                        { challenge: `You realize you were wrong about ${topic}!`, option1: { name: 'Update Your Understanding', icon: 'üîÑ', traits: ['Learn the truth', 'Grow smarter', 'Stay humble'] }, option2: { name: 'Pretend You Were Right', icon: 'üôÖ', traits: ['Stay wrong', 'No growth', 'Miss learning'] }, concept: 'Changing our minds when we learn new facts is smart' }
                    ]
                }
            };
        }

        // Track which fact/challenge index was used for each topic to avoid repeats
        let usedFactIndices = {};
        let usedChallengeIndices = {};

        // Helper function to deduplicate arrays
        function deduplicateArray(arr) {
            return [...new Set(arr)];
        }

        function deduplicateBadges(badges) {
            const seen = new Set();
            return badges.filter(badge => {
                if (seen.has(badge.id)) return false;
                seen.add(badge.id);
                return true;
            });
        }

        // Get relative time string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 14) return 'Last week';
            return date.toLocaleDateString();
        }

        // localStorage Functions
        function saveToLocalStorage() {
            const explorationsData = JSON.parse(localStorage.getItem('curiosityExplorations')) || {};

            if (gameState.currentTopic) {
                const topicKey = gameState.currentTopic.toLowerCase();
                const existingTopic = explorationsData[topicKey] || {
                    topic: gameState.currentTopic,
                    badges: [],
                    concepts: [],
                    lastExplored: null,
                    missionsCompleted: []
                };

                // Merge badges and deduplicate
                const allBadges = [...existingTopic.badges, ...gameState.badges];
                existingTopic.badges = deduplicateBadges(allBadges);

                // Merge concepts and deduplicate
                const allConcepts = [...existingTopic.concepts, ...gameState.conceptsLearned];
                existingTopic.concepts = deduplicateArray(allConcepts);

                existingTopic.lastExplored = new Date().toISOString();
                existingTopic.missionsCompleted = gameState.completedMissions;

                explorationsData[topicKey] = existingTopic;
                localStorage.setItem('curiosityExplorations', JSON.stringify(explorationsData));
            }
        }

        function loadTopicData(topic) {
            const explorationsData = JSON.parse(localStorage.getItem('curiosityExplorations')) || {};
            const topicKey = topic.toLowerCase();
            return explorationsData[topicKey] || null;
        }

        function getAllExplorations() {
            return JSON.parse(localStorage.getItem('curiosityExplorations')) || {};
        }

        // Topic Selection - Go directly to the game (skip mission selection)
        function selectTopicAndStart(topic) {
            gameState.currentTopic = topic.charAt(0).toUpperCase() + topic.slice(1).toLowerCase();
            gameState.completedMissions = [];
            gameState.badges = [];
            gameState.conceptsLearned = [];
            gameState.questionsAsked = [];
            gameState.ideasTested = [];

            // Load topic data from database or generate custom content
            const topicKey = gameState.currentTopic.toLowerCase();
            if (topicDatabase[topicKey]) {
                gameState.currentTopicData = topicDatabase[topicKey];
            } else {
                gameState.currentTopicData = generateCustomTopicData(gameState.currentTopic);
            }

            // Go directly to Spot the Mistake (skip mission selection)
            startMission2();
        }

        // Legacy function for compatibility
        function selectTopic(topic) {
            selectTopicAndStart(topic);
        }

        function startExploring() {
            const topicInput = document.getElementById('topicInput');
            if (!topicInput || !topicInput.value.trim()) {
                return;
            }
            selectTopicAndStart(topicInput.value.trim());
        }

        // Voice input for custom topic
        function sayMyTopic() {
            const btn = document.getElementById('sayTopicBtn');
            const status = document.getElementById('sayTopicStatus');
            const fallbackInput = document.getElementById('customTopicInput');

            // Check for speech recognition support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                // Show fallback text input
                status.textContent = 'Voice not available - type instead!';
                status.style.display = 'block';
                fallbackInput.style.display = 'block';
                document.getElementById('customTopicText').focus();
                return;
            }

            try {
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                // Update UI for listening
                btn.classList.add('listening');
                btn.innerHTML = '<span style="font-size: 32px;">üé§</span><span>Listening...</span>';
                status.textContent = 'Say a topic like "cars" or "butterflies"';
                status.style.display = 'block';

                recognition.onresult = (event) => {
                    const topic = event.results[0][0].transcript.trim();
                    btn.classList.remove('listening');
                    btn.innerHTML = '<span style="font-size: 32px;">üé§</span><span>Say Something Else!</span>';

                    if (topic) {
                        status.textContent = `Great! Let's explore ${topic}!`;
                        speakText(`Great! Let's explore ${topic}!`);
                        setTimeout(() => {
                            status.style.display = 'none';
                            selectTopicAndStart(topic);
                        }, 1500);
                    }
                };

                recognition.onerror = (event) => {
                    console.log('Speech recognition error:', event.error);
                    btn.classList.remove('listening');
                    btn.innerHTML = '<span style="font-size: 32px;">üé§</span><span>Say Something Else!</span>';

                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        status.textContent = 'Microphone blocked - type instead!';
                        fallbackInput.style.display = 'block';
                        document.getElementById('customTopicText').focus();
                    } else {
                        status.textContent = 'Tap to try again, or type below';
                        fallbackInput.style.display = 'block';
                    }
                };

                recognition.onend = () => {
                    btn.classList.remove('listening');
                    btn.innerHTML = '<span style="font-size: 32px;">üé§</span><span>Say Something Else!</span>';
                };

                recognition.start();
            } catch (e) {
                console.log('Speech recognition failed:', e);
                status.textContent = 'Voice not working - type instead!';
                status.style.display = 'block';
                fallbackInput.style.display = 'block';
                document.getElementById('customTopicText').focus();
            }
        }

        // Start game with typed custom topic
        function startCustomTopic() {
            const input = document.getElementById('customTopicText');
            const topic = input.value.trim();
            if (topic) {
                document.getElementById('customTopicInput').style.display = 'none';
                document.getElementById('sayTopicStatus').style.display = 'none';
                input.value = '';
                selectTopicAndStart(topic);
            }
        }

        // Allow Enter key to submit custom topic
        document.addEventListener('DOMContentLoaded', function() {
            const customInput = document.getElementById('customTopicText');
            if (customInput) {
                customInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        startCustomTopic();
                    }
                });
            }
        });

        function showWelcomeBackBanner(topicData) {
            const banner = document.getElementById('welcomeBackBanner');
            const lastDate = new Date(topicData.lastExplored).toLocaleDateString();

            banner.innerHTML = `
                <div class="welcome-back-banner">
                    <h3>Welcome Back to ${gameState.currentTopic}! ${gameState.currentTopicData.emoji}</h3>
                    <p>Last time you explored this on ${lastDate}!<br>
                    You learned: ${topicData.concepts[0] || 'lots of cool things'}<br>
                    Ready for more missions?</p>
                </div>
            `;
        }

        function populateMissions() {
            const missionGrid = document.getElementById('missionGrid');
            const topicData = gameState.currentTopicData;

            document.getElementById('missionSelectTitle').textContent = `Explore ${gameState.currentTopic}!`;

            missionGrid.innerHTML = `
                <div class="mission-card" onclick="startMission2()">
                    <h3>${topicData.mission2.icon} ${topicData.mission2.title}</h3>
                    <p>${topicData.mission2.description}</p>
                </div>
            `;

            // Show recap button if any missions completed
            updateRecapButton();
        }

        function updateRecapButton() {
            const recapBtn = document.getElementById('recapBtn');
            if (gameState.completedMissions.length > 0) {
                recapBtn.style.display = 'inline-block';
            } else {
                recapBtn.style.display = 'none';
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const dashboardContent = document.getElementById('dashboardContent');
            const emptyDashboard = document.getElementById('emptyDashboard');

            // Clean up duplicates in localStorage first
            cleanupLocalStorage();

            const explorations = getAllExplorations();
            const topics = Object.values(explorations);

            if (topics.length === 0) {
                dashboardContent.innerHTML = '';
                emptyDashboard.style.display = 'block';
                return;
            }

            emptyDashboard.style.display = 'none';

            // Sort by most recent
            topics.sort((a, b) => new Date(b.lastExplored) - new Date(a.lastExplored));

            dashboardContent.innerHTML = topics.map(topicData => {
                const topicKey = topicData.topic.toLowerCase();
                const emoji = topicDatabase[topicKey]?.emoji || 'üéØ';
                const date = new Date(topicData.lastExplored).toLocaleDateString();

                // Deduplicate badges for display
                const uniqueBadges = deduplicateBadges(topicData.badges || []);

                return `
                    <div class="topic-card" onclick="continueExploring('${topicData.topic}')">
                        <div class="topic-card-header">${emoji} ${topicData.topic}</div>
                        <div class="topic-card-meta">Last explored: ${date}</div>
                        <div class="topic-card-badges">
                            ${uniqueBadges.map(b => `<div class="mini-badge">${b.name}</div>`).join('')}
                        </div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 16px; padding: 12px;">
                            Continue Exploring
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Clean up duplicates in localStorage
        function cleanupLocalStorage() {
            const explorationsData = JSON.parse(localStorage.getItem('curiosityExplorations')) || {};

            Object.keys(explorationsData).forEach(topicKey => {
                const topic = explorationsData[topicKey];
                if (topic.badges) {
                    topic.badges = deduplicateBadges(topic.badges);
                }
                if (topic.concepts) {
                    topic.concepts = deduplicateArray(topic.concepts);
                }
            });

            localStorage.setItem('curiosityExplorations', JSON.stringify(explorationsData));
        }

        function continueExploring(topic) {
            document.getElementById('topicInput').value = topic;
            startExploring();
        }

        // Recap Functions
        function showRecap() {
            const topicData = gameState.currentTopicData;

            document.getElementById('recapTitle').textContent = `What You Discovered About ${gameState.currentTopic}!`;
            document.getElementById('recapSubtitle').textContent = `Amazing work, explorer! ${topicData.emoji}`;

            // Concepts learned (deduplicated)
            const uniqueConcepts = deduplicateArray(gameState.conceptsLearned);
            const conceptsContainer = document.getElementById('conceptsLearned');
            conceptsContainer.innerHTML = uniqueConcepts.map(concept =>
                `<div class="concept-bubble">${concept}</div>`
            ).join('');

            // Recap cards
            const recapGrid = document.getElementById('recapGrid');
            recapGrid.innerHTML = `
                <div class="recap-card">
                    <div class="recap-card-icon">üéØ</div>
                    <div class="recap-card-title">Missions Completed</div>
                    <div class="recap-card-content">${gameState.completedMissions.length} out of 2</div>
                </div>
                <div class="recap-card">
                    <div class="recap-card-icon">üí°</div>
                    <div class="recap-card-title">Ideas Tested</div>
                    <div class="recap-card-content">${gameState.ideasTested.length || 'Many'} different ideas!</div>
                </div>
                <div class="recap-card">
                    <div class="recap-card-icon">‚ùì</div>
                    <div class="recap-card-title">Questions Asked</div>
                    <div class="recap-card-content">You wondered about ${gameState.questionsAsked.length || 'lots of'} things!</div>
                </div>
            `;

            // Badges (deduplicated)
            const uniqueBadges = deduplicateBadges(gameState.badges);
            const recapBadges = document.getElementById('recapBadges');
            recapBadges.innerHTML = uniqueBadges.map(b =>
                `<div class="badge">${b.name}</div>`
            ).join('');

            showScreen('recap');
        }

        function finishSession() {
            saveToLocalStorage();
            updateDashboard();
            showScreen('welcome');

            // Reset for next session
            gameState.currentTopic = null;
            gameState.currentTopicData = null;
            gameState.completedMissions = [];
            gameState.badges = [];
            gameState.conceptsLearned = [];
            gameState.questionsAsked = [];
            gameState.ideasTested = [];

            document.getElementById('topicInput').value = '';
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            // Update dashboard when showing it
            if (screenId === 'dashboard') {
                updateDashboard();
            }

            // Update parent view when showing it
            if (screenId === 'parentView') {
                updateParentView();
            }

            // Check API key and clear chat when showing ask question screen
            if (screenId === 'askQuestion') {
                clearChat();  // Always start fresh session
                checkApiKeyAndShowChat();
                speakText('Hi! What do you want to know?');
            }

            // Auto-read instructions for each screen
            const screenAudio = {
                'welcome': 'Pick a topic! Tap one to start!',
                'mission2-intro': 'Find the silly fact! Tap Let\'s Look!',
                'mission2-facts': 'Which one sounds wrong? Tap it!',
                'mission2-correct': 'Yes! You got it!',
                'mission2-hint': 'Hmm, try again!',
                'mission2-success': 'Amazing! You found them all!',
                'missionSelect': `Let's explore ${gameState.currentTopic}!`,
                'askQuestion': 'Hi! What do you want to know?'
            };

            if (screenAudio[screenId]) {
                setTimeout(() => speakText(screenAudio[screenId]), 300);
            }
        }

        // Save API key from parent view
        function saveParentApiKey(key) {
            if (key && key.trim()) {
                localStorage.setItem('openaiApiKey', key.trim());
                document.getElementById('apiKeyStatus').textContent = '‚úì API key saved';
            }
        }

        // Populate parent view with topics and facts learned
        function updateParentView() {
            // Show existing API key status
            const existingKey = localStorage.getItem('openaiApiKey');
            const apiKeyInput = document.getElementById('parentApiKeyInput');
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (existingKey && apiKeyInput) {
                apiKeyInput.value = existingKey.substring(0, 7) + '...' + existingKey.slice(-4);
                apiKeyStatus.textContent = '‚úì API key configured';
            }

            const parentTopicsList = document.getElementById('parentTopicsList');
            const explorations = getAllExplorations();
            const topics = Object.values(explorations);

            // Update summary card
            const totalBadges = topics.reduce((sum, t) => sum + deduplicateBadges(t.badges || []).length, 0);
            const totalMissions = topics.reduce((sum, t) => sum + (t.completedMissions?.length || 0), 0);
            document.getElementById('summaryTopics').textContent = topics.length;
            document.getElementById('summaryBadges').textContent = totalBadges;
            document.getElementById('summaryMissions').textContent = totalMissions || topics.length;

            if (topics.length === 0) {
                parentTopicsList.innerHTML = '<p style="color: #888; font-style: italic;">No activity yet. Play a game to see progress!</p>';
                return;
            }

            // Sort by most recent
            topics.sort((a, b) => new Date(b.lastExplored) - new Date(a.lastExplored));

            let html = '';

            topics.forEach(topicData => {
                const topicKey = topicData.topic.toLowerCase();
                const emoji = topicDatabase[topicKey]?.emoji || 'üî¨';
                const timeAgo = getTimeAgo(new Date(topicData.lastExplored));
                const uniqueConcepts = deduplicateArray(topicData.concepts || []);
                const uniqueBadges = deduplicateBadges(topicData.badges || []);

                html += `
                    <div style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #2c3e50; margin: 0; font-size: 18px;">
                                ${emoji} ${topicData.topic}
                            </h4>
                            <span style="font-size: 12px; color: #888;">${timeAgo}</span>
                        </div>
                `;

                // Show badges earned
                if (uniqueBadges.length > 0) {
                    html += `
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #666; font-size: 13px;">üèÜ Badges Earned:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                ${uniqueBadges.map(b => `<span style="background: #fff3e0; padding: 3px 8px; border-radius: 10px; font-size: 12px;">${b.name}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }

                // Show top 4 concepts/facts learned
                if (uniqueConcepts.length > 0) {
                    const topConcepts = uniqueConcepts.slice(0, 4);
                    html += `
                        <div>
                            <strong style="color: #666; font-size: 13px;">üí° Key Things Learned:</strong>
                            <ul style="margin: 5px 0 0 0; padding-left: 20px; color: #555; font-size: 14px; line-height: 1.6;">
                                ${topConcepts.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                html += '</div>';
            });

            parentTopicsList.innerHTML = html;
        }

        // Mission 1: Build Something (Dynamic)
        function startMission1() {
            const m1 = gameState.currentTopicData.mission1;
            const topicData = gameState.currentTopicData;

            gameState.currentPlane = { wings: null, nose: null };

            // Update intro screen
            document.getElementById('mission1IntroTitle').textContent = m1.title;
            document.getElementById('mission1IntroSubtitle').innerHTML = `You get to ${m1.buildPrompt.toLowerCase()}!<br>Pick the parts you think will work best.`;

            // Update build screen
            document.getElementById('mission1BuildTitle').textContent = m1.buildPrompt;

            // Update result screen title
            document.getElementById('mission1ResultTitle').textContent = `Let's see how it works!`;

            // Update improve screen
            document.getElementById('mission1ImproveTitle').textContent = `What could make it work better?`;
            const part1Type = m1.partType1 || 'part';
            const part2Type = m1.partType2 || 'part';
            document.getElementById('improveButtons').innerHTML = `
                <button class="choice-btn" onclick="improveChoice('part1')">
                    ‚ú® Change the ${part1Type}
                </button>
                <button class="choice-btn" onclick="improveChoice('part2')">
                    ‚ú® Change the ${part2Type}
                </button>
                <button class="choice-btn" onclick="improveChoice('both')">
                    ‚≠ê Change both parts
                </button>
            `;

            // Update part labels dynamically based on topic
            const part1Label = document.getElementById('part1Label');
            const part2Label = document.getElementById('part2Label');

            part1Label.textContent = `Pick ${part1Type}:`;
            part2Label.textContent = `Pick ${part2Type}:`;

            // Update part options dynamically
            updatePartOptions('part1Options', part1Type);
            updatePartOptions('part2Options', part2Type);

            // Show/hide preview based on topic (only show for planes)
            const buildPreview = document.getElementById('buildPreview');
            const previewLabel = document.getElementById('previewLabel');
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                buildPreview.style.display = 'block';
                previewLabel.textContent = 'Your plane!';
            } else {
                buildPreview.style.display = 'none';
            }

            // Reset part selections
            document.querySelectorAll('.part-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('testBtn').style.display = 'none';

            // Update test button text based on topic
            const testBtn = document.getElementById('testBtn');
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                testBtn.textContent = 'Test My Plane!';
            } else {
                testBtn.textContent = 'Test It!';
            }

            // Reset preview plane
            resetPreviewPlane();

            // Reset flight animation plane
            resetFlightPlane();

            // Track the question
            gameState.questionsAsked.push(`What parts work best for ${gameState.currentTopic}?`);

            showScreen('mission1-intro');
        }

        // Helper function to update part options based on part type
        function updatePartOptions(containerId, partType) {
            const container = document.getElementById(containerId);

            // Define part options for different types
            const partDefinitions = {
                // Planes
                wings: [
                    { value: 'tiny', label: 'Tiny Wings' },
                    { value: 'medium', label: 'Medium Wings' },
                    { value: 'huge', label: 'Huge Wings' }
                ],
                nose: [
                    { value: 'pointy', label: 'Pointy Nose' },
                    { value: 'round', label: 'Round Nose' },
                    { value: 'flat', label: 'Flat Nose' }
                ],
                // Stars - Telescope
                lens: [
                    { value: 'tiny', label: 'Small Lens' },
                    { value: 'medium', label: 'Medium Lens' },
                    { value: 'huge', label: 'Big Lens' }
                ],
                length: [
                    { value: 'pointy', label: 'Short Tube' },
                    { value: 'round', label: 'Medium Tube' },
                    { value: 'flat', label: 'Long Tube' }
                ],
                // Dinosaurs
                size: [
                    { value: 'tiny', label: 'Tiny Size' },
                    { value: 'medium', label: 'Medium Size' },
                    { value: 'huge', label: 'Huge Size' }
                ],
                teeth: [
                    { value: 'pointy', label: 'Sharp Teeth' },
                    { value: 'round', label: 'Flat Teeth' },
                    { value: 'flat', label: 'No Teeth' }
                ],
                // Ocean - Submarine
                hull: [
                    { value: 'tiny', label: 'Thin Hull' },
                    { value: 'medium', label: 'Medium Hull' },
                    { value: 'huge', label: 'Strong Hull' }
                ],
                windows: [
                    { value: 'pointy', label: 'Small Window' },
                    { value: 'round', label: 'Medium Window' },
                    { value: 'flat', label: 'Big Window' }
                ],
                // Robots
                arms: [
                    { value: 'tiny', label: 'Small Arms' },
                    { value: 'medium', label: 'Medium Arms' },
                    { value: 'huge', label: 'Strong Arms' }
                ],
                wheels: [
                    { value: 'pointy', label: 'Small Wheels' },
                    { value: 'round', label: 'Medium Wheels' },
                    { value: 'flat', label: 'Big Wheels' }
                ],
                // Space - Rocket
                engines: [
                    { value: 'tiny', label: 'Small Engine' },
                    { value: 'medium', label: 'Medium Engine' },
                    { value: 'huge', label: 'Big Engine' }
                ],
                'fuel tank': [
                    { value: 'pointy', label: 'Small Tank' },
                    { value: 'round', label: 'Medium Tank' },
                    { value: 'flat', label: 'Large Tank' }
                ],
                // Custom topic
                shape: [
                    { value: 'pointy', label: 'Pointy Shape' },
                    { value: 'round', label: 'Round Shape' },
                    { value: 'flat', label: 'Flat Shape' }
                ],
                // Generic fallback
                'part A': [
                    { value: 'tiny', label: 'Small' },
                    { value: 'medium', label: 'Medium' },
                    { value: 'huge', label: 'Large' }
                ],
                'part B': [
                    { value: 'pointy', label: 'Type 1' },
                    { value: 'round', label: 'Type 2' },
                    { value: 'flat', label: 'Type 3' }
                ]
            };

            // Get part options or use generic
            const options = partDefinitions[partType] || partDefinitions['part A'];

            // Generate HTML for options - text labels only, no icons
            container.innerHTML = options.map(opt => `
                <div class="part-option" data-part="${partType}" data-value="${opt.value}" onclick="selectPart('${partType}', '${opt.value}', this)">
                    <div class="label">${opt.label}</div>
                </div>
            `).join('');
        }

        function resetPreviewPlane() {
            const previewSvg = document.getElementById('planePreview');
            if (previewSvg) {
                // Reset wing
                const wing = document.getElementById('previewWing');
                if (wing) {
                    wing.setAttribute('rx', '15');
                    wing.setAttribute('ry', '25');
                    wing.style.fill = '#f39c12';
                }

                // Reset nose - replace with default circle
                const oldNose = document.getElementById('previewNose');
                if (oldNose) {
                    const newNose = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    newNose.id = 'previewNose';
                    newNose.setAttribute('cx', '100');
                    newNose.setAttribute('cy', '40');
                    newNose.setAttribute('r', '10');
                    newNose.style.fill = '#3498db';
                    oldNose.parentNode.replaceChild(newNose, oldNose);
                }
            }
        }

        function resetFlightPlane() {
            const planeAnimation = document.getElementById('planeAnimation');
            if (planeAnimation) {
                // Reset animation classes and position
                planeAnimation.classList.remove('flight-great', 'flight-okay', 'flight-poor');
                planeAnimation.style.left = '30px';
                planeAnimation.style.top = '180px';

                // Reset wing
                const wing = planeAnimation.querySelector('#planeWing');
                if (wing) {
                    wing.setAttribute('rx', '20');
                    wing.setAttribute('ry', '35');
                    wing.style.fill = '#f39c12';
                }

                // Reset nose - replace with default path
                const oldNose = planeAnimation.querySelector('#planeNose');
                if (oldNose) {
                    const newNose = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    newNose.id = 'planeNose';
                    newNose.classList.add('plane-nose');
                    newNose.setAttribute('d', 'M95,40 Q115,40 105,30 Q95,35 95,40 Q95,45 105,50 Q115,40 95,40');
                    newNose.style.fill = '#3498db';
                    oldNose.parentNode.replaceChild(newNose, oldNose);
                }
            }
        }

        function selectPart(partType, value, element) {
            // Deselect all parts of this type
            document.querySelectorAll(`[data-part="${partType}"]`).forEach(el => {
                el.classList.remove('selected');
            });

            // Select this part
            element.classList.add('selected');

            // Store the selection - map to generic keys for the logic
            const m1 = gameState.currentTopicData.mission1;
            if (partType === m1.partType1) {
                gameState.currentPlane.wings = value; // Use 'wings' as first part key
            } else if (partType === m1.partType2) {
                gameState.currentPlane.nose = value; // Use 'nose' as second part key
            }

            // Update live preview (only for planes)
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                updatePreview();
            }

            // Show test button if both parts selected
            if (gameState.currentPlane.wings && gameState.currentPlane.nose) {
                document.getElementById('testBtn').style.display = 'block';
            }
        }

        function updatePreview() {
            const previewWing = document.getElementById('previewWing');
            const previewNose = document.getElementById('previewNose');
            const previewSvg = document.getElementById('planePreview');

            // Update wing preview
            if (previewWing && gameState.currentPlane.wings) {
                switch(gameState.currentPlane.wings) {
                    case 'tiny':
                        previewWing.setAttribute('rx', '8');
                        previewWing.setAttribute('ry', '12');
                        previewWing.style.fill = '#e74c3c';
                        break;
                    case 'medium':
                        previewWing.setAttribute('rx', '18');
                        previewWing.setAttribute('ry', '32');
                        previewWing.style.fill = '#27ae60';
                        break;
                    case 'huge':
                        previewWing.setAttribute('rx', '28');
                        previewWing.setAttribute('ry', '45');
                        previewWing.style.fill = '#e74c3c';
                        break;
                }
            }

            // Update nose preview - need to replace the element
            if (previewNose && gameState.currentPlane.nose) {
                const oldNose = document.getElementById('previewNose');
                let newNose;

                switch(gameState.currentPlane.nose) {
                    case 'pointy':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                        newNose.setAttribute('points', '95,40 115,40 95,30 95,50');
                        newNose.style.fill = '#27ae60';
                        break;
                    case 'round':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        newNose.setAttribute('cx', '100');
                        newNose.setAttribute('cy', '40');
                        newNose.setAttribute('r', '10');
                        newNose.style.fill = '#f39c12';
                        break;
                    case 'flat':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        newNose.setAttribute('x', '95');
                        newNose.setAttribute('y', '30');
                        newNose.setAttribute('width', '12');
                        newNose.setAttribute('height', '20');
                        newNose.style.fill = '#e74c3c';
                        break;
                }

                if (newNose) {
                    newNose.id = 'previewNose';
                    oldNose.parentNode.replaceChild(newNose, oldNose);
                }
            }
        }

        function testPlane() {
            showScreen('mission1-result');

            const plane = gameState.currentPlane;
            const planeEl = document.getElementById('planeAnimation');
            const feedbackEl = document.getElementById('flightFeedback');
            const flightLabel = document.getElementById('flightLabel');
            const topicData = gameState.currentTopicData;
            const m1 = topicData.mission1;

            // Track the idea tested
            gameState.ideasTested.push(`Tested ${m1.partType1}: ${plane.wings} and ${m1.partType2}: ${plane.nose}`);

            // Show plane visual only for planes, generic visual for others
            const planeVisual = document.getElementById('planeVisual');
            const genericVisual = document.getElementById('genericResultVisual');
            const resultEmoji = document.getElementById('resultEmoji');

            if (gameState.currentTopic.toLowerCase() === 'planes') {
                planeVisual.style.display = 'block';
                genericVisual.style.display = 'none';
            } else {
                planeVisual.style.display = 'none';
                genericVisual.style.display = 'block';
                resultEmoji.textContent = topicData.emoji;
            }

            // Update plane appearance based on selected parts
            updatePlaneAppearance(planeEl, plane);

            // Reset animation
            planeEl.classList.remove('flight-great', 'flight-okay', 'flight-poor');
            planeEl.style.left = '30px';
            planeEl.style.top = '180px';

            // Determine flight quality based on parts
            let flightQuality = 'poor';
            let feedback = '';

            if (plane.wings === 'medium' && plane.nose === 'pointy') {
                flightQuality = 'great';
                feedback = "Wow! It worked really well!<br>The medium parts gave it the right balance,<br>and the pointy part cut through smoothly.";
            } else if (plane.wings === 'medium' || plane.nose === 'pointy') {
                flightQuality = 'okay';
                if (plane.wings === 'medium') {
                    feedback = "Not bad! It worked pretty well.<br>The medium part helped!<br>But what about the other part?";
                } else {
                    feedback = "Not bad! It worked pretty well.<br>The pointy part helped!<br>But what about the other part?";
                }
            } else {
                flightQuality = 'poor';
                if (plane.wings === 'tiny') {
                    feedback = "Hmm, it wobbled a lot.<br>The tiny part was too small!<br>What if it was bigger?";
                } else if (plane.wings === 'huge') {
                    feedback = "Hmm, it moved slowly.<br>The huge part was too big!<br>What if it was smaller?";
                } else if (plane.nose === 'flat') {
                    feedback = "Hmm, it couldn't go very far.<br>The flat part slowed it down.<br>What if it was more pointy?";
                } else {
                    feedback = "Hmm, it didn't work quite right.<br>Let's think about the shape!";
                }
            }

            feedbackEl.innerHTML = feedback;

            // Update label and generic visual based on quality
            flightLabel.className = 'flight-label';
            if (flightQuality === 'great') {
                flightLabel.textContent = 'Works Great!';
                flightLabel.classList.add('label-great');
                resultEmoji.textContent = topicData.emoji + '‚ú®';
                genericVisual.style.background = 'linear-gradient(135deg, #a8edea 0%, #d4fc79 100%)';
            } else if (flightQuality === 'okay') {
                flightLabel.textContent = 'Getting There!';
                flightLabel.classList.add('label-okay');
                resultEmoji.textContent = topicData.emoji + 'ü§î';
                genericVisual.style.background = 'linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%)';
            } else {
                flightLabel.textContent = 'Needs Work!';
                flightLabel.classList.add('label-poor');
                resultEmoji.textContent = topicData.emoji + 'üò¨';
                genericVisual.style.background = 'linear-gradient(135deg, #fab1a0 0%, #e17055 100%)';
            }

            // Animate plane with appropriate flight class (only for planes)
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                setTimeout(() => {
                    planeEl.classList.add('flight-' + flightQuality);
                }, 100);
            }
        }

        function updatePlaneAppearance(planeEl, parts) {
            const wingEl = planeEl.querySelector('#planeWing');

            // Update wing size
            if (wingEl) {
                switch(parts.wings) {
                    case 'tiny':
                        wingEl.setAttribute('rx', '10');
                        wingEl.setAttribute('ry', '15');
                        wingEl.style.fill = '#e74c3c'; // Red for bad choice
                        break;
                    case 'medium':
                        wingEl.setAttribute('rx', '20');
                        wingEl.setAttribute('ry', '35');
                        wingEl.style.fill = '#27ae60'; // Green for good choice
                        break;
                    case 'huge':
                        wingEl.setAttribute('rx', '30');
                        wingEl.setAttribute('ry', '50');
                        wingEl.style.fill = '#e74c3c'; // Red for bad choice
                        break;
                }
            }

            // Update nose shape - always replace the element
            const oldNose = planeEl.querySelector('#planeNose');
            if (oldNose) {
                let newNose;

                switch(parts.nose) {
                    case 'pointy':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                        newNose.setAttribute('points', '95,40 120,40 95,30 95,50');
                        newNose.style.fill = '#27ae60'; // Green for good choice
                        break;
                    case 'round':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                        newNose.setAttribute('cx', '102');
                        newNose.setAttribute('cy', '40');
                        newNose.setAttribute('rx', '12');
                        newNose.setAttribute('ry', '10');
                        newNose.style.fill = '#f39c12'; // Orange for okay choice
                        break;
                    case 'flat':
                        newNose = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        newNose.setAttribute('x', '95');
                        newNose.setAttribute('y', '28');
                        newNose.setAttribute('width', '15');
                        newNose.setAttribute('height', '24');
                        newNose.style.fill = '#e74c3c'; // Red for bad choice
                        break;
                }

                if (newNose) {
                    newNose.id = 'planeNose';
                    newNose.classList.add('plane-nose');
                    oldNose.parentNode.replaceChild(newNose, oldNose);
                }
            }
        }

        function improveChoice(choice) {
            const improvedPlane = document.getElementById('improvedPlaneAnimation');
            const feedbackEl = document.getElementById('improvementFeedback');
            const m1 = gameState.currentTopicData.mission1;
            const topicData = gameState.currentTopicData;

            let feedback = '';
            const part1Name = m1.partType1 || 'first part';
            const part2Name = m1.partType2 || 'second part';

            gameState.ideasTested.push(`Improved by changing ${choice}`);

            if (choice === 'part1') {
                feedback = `Great thinking!<br>You changed the ${part1Name}.<br>Now it works much better!`;
            } else if (choice === 'part2') {
                feedback = `Smart idea!<br>You changed the ${part2Name}.<br>Now it works smoothly!`;
            } else if (choice === 'both') {
                feedback = `Excellent thinking!<br>You improved both the ${part1Name} and ${part2Name}!<br>Now everything works together. Perfect!`;
            }

            feedbackEl.innerHTML = feedback;

            // Add concept learned
            gameState.conceptsLearned.push(m1.conceptLearned);

            // Update badge display dynamically
            const badgeDisplay = document.getElementById('mission1BadgeDisplay');
            const badgeName = `${topicData.mission1.icon} ${topicData.name} Builder`;
            badgeDisplay.innerHTML = `<div class="badge">${badgeName}</div>`;

            // Show/hide improved plane visual based on topic
            const improvedPlaneVisual = document.getElementById('improvedPlaneVisual');
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                improvedPlaneVisual.style.display = 'block';
            } else {
                improvedPlaneVisual.style.display = 'none';
            }

            showScreen('mission1-final');

            // Reset and animate improved plane (only for planes topic)
            if (gameState.currentTopic.toLowerCase() === 'planes') {
                improvedPlane.classList.remove('flight-improved');
                improvedPlane.style.left = '30px';
                improvedPlane.style.top = '150px';

                // Animate improved flight after a short delay
                setTimeout(() => {
                    improvedPlane.classList.add('flight-improved');
                }, 300);
            }
        }

        // Store the current fact for Mission 2
        let currentMission2Fact = null;
        let mission2QuestionCount = 0;
        let mission2ConceptsLearned = [];
        let mission2GeneratedFacts = []; // Cache generated facts for this session

        // Generate a fact-checking question using LLM
        async function generateMission2Question(topic, questionNumber) {
            const apiKey = localStorage.getItem('openaiApiKey');

            if (!apiKey) {
                // Fallback to template if no API key
                return getFallbackFact(topic);
            }

            const previousFacts = mission2GeneratedFacts.map(f => f.wrong).join(', ');

            const prompt = `Generate a fact-checking question for a 5-7 year old child about "${topic}".

Create ONE pair of facts:
1. A TRUE fact about ${topic} (simple, interesting, age-appropriate)
2. A FALSE fact about ${topic} (sounds believable but is wrong - make it obviously silly for a kid)

The false fact should be clearly wrong but fun/silly (like "planes are made of chocolate" or "dinosaurs could fly to the moon").

${previousFacts ? `Do NOT repeat these wrong facts already used: ${previousFacts}` : ''}

Respond in this exact JSON format only:
{
  "correct": "The true fact here (short, simple words)",
  "wrong": "The false fact here (short, silly, clearly wrong)",
  "correctIcon": "one emoji for the true fact",
  "wrongIcon": "one emoji for the false fact",
  "concept": "Why the wrong fact is false (1 simple sentence for kids)"
}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 200,
                        temperature: 0.9
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const content = data.choices[0].message.content.trim();

                // Parse JSON from response (handle markdown code blocks)
                let jsonStr = content;
                if (content.includes('```')) {
                    jsonStr = content.replace(/```json?\n?/g, '').replace(/```/g, '').trim();
                }

                const fact = JSON.parse(jsonStr);
                mission2GeneratedFacts.push(fact);
                return fact;

            } catch (error) {
                console.error('Error generating question:', error);
                return getFallbackFact(topic);
            }
        }

        // Fallback facts for when LLM is unavailable
        function getFallbackFact(topic) {
            const fallbacks = [
                { correct: `You can learn about ${topic} from books`, wrong: `${topic} is just make-believe`, correctIcon: 'üìö', wrongIcon: 'ü¶Ñ', concept: `${topic} is real and we can learn about it!` },
                { correct: `Scientists study ${topic}`, wrong: `Nobody knows anything about ${topic}`, correctIcon: 'üî¨', wrongIcon: 'ü§∑', concept: 'Scientists have learned a lot!' },
                { correct: `There are many facts about ${topic}`, wrong: `${topic} is too boring to learn about`, correctIcon: '‚ú®', wrongIcon: 'üò¥', concept: 'Every topic has cool things to discover!' },
                { correct: `We can ask questions about ${topic}`, wrong: `Questions about ${topic} have no answers`, correctIcon: '‚ùì', wrongIcon: 'üö´', concept: 'Questions help us learn!' },
                { correct: `${topic} can be explored and understood`, wrong: `${topic} is impossible to understand`, correctIcon: 'üß†', wrongIcon: '‚ùå', concept: 'We can understand anything with curiosity!' }
            ];
            return fallbacks[mission2QuestionCount % fallbacks.length];
        }

        // Mission 2: Spot the Mistake (Dynamic)
        function startMission2() {
            const m2 = gameState.currentTopicData.mission2;

            // Update the intro screen
            document.querySelector('#mission2-intro h2').textContent = m2.title;
            document.querySelector('#mission2-intro .subtitle').innerHTML = `Even smart computers can get facts wrong!<br>Can you find 5 wrong facts?`;

            // Reset question count
            mission2QuestionCount = 0;
            mission2ConceptsLearned = [];

            // Track the question
            gameState.questionsAsked.push(`Which facts about ${gameState.currentTopic} are wrong?`);

            showScreen('mission2-intro');
        }

        function startMission2Questions() {
            mission2QuestionCount = 0;
            mission2ConceptsLearned = [];
            mission2GeneratedFacts = []; // Reset generated facts for new session
            loadMission2Question();
        }

        // Update progress stars visually
        function updateProgressStars(completed) {
            const progressEl = document.getElementById('mission2Progress');
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < completed) {
                    stars += '<span class="star filled">‚òÖ</span>';
                } else {
                    stars += '<span class="star">‚òÜ</span>';
                }
            }
            progressEl.innerHTML = stars;
        }

        async function loadMission2Question() {
            const topic = gameState.currentTopic;

            // Update progress indicator with stars
            updateProgressStars(mission2QuestionCount);

            // Show loading state
            const choiceButtons = document.querySelectorAll('#mission2-facts .choice-btn');
            choiceButtons[0].innerHTML = '‚è≥ Loading...';
            choiceButtons[0].setAttribute('onclick', '');
            choiceButtons[1].innerHTML = '‚è≥ Loading...';
            choiceButtons[1].setAttribute('onclick', '');

            showScreen('mission2-facts');

            // Generate question using LLM
            currentMission2Fact = await generateMission2Question(topic, mission2QuestionCount + 1);

            // Randomize the order of correct and wrong facts
            const showCorrectFirst = Math.random() < 0.5;

            if (showCorrectFirst) {
                choiceButtons[0].innerHTML = `${currentMission2Fact.correctIcon} ${currentMission2Fact.correct}`;
                choiceButtons[0].setAttribute('onclick', "checkFact('correct')");
                choiceButtons[1].innerHTML = `${currentMission2Fact.wrongIcon} ${currentMission2Fact.wrong}`;
                choiceButtons[1].setAttribute('onclick', "checkFact('wrong')");
            } else {
                choiceButtons[0].innerHTML = `${currentMission2Fact.wrongIcon} ${currentMission2Fact.wrong}`;
                choiceButtons[0].setAttribute('onclick', "checkFact('wrong')");
                choiceButtons[1].innerHTML = `${currentMission2Fact.correctIcon} ${currentMission2Fact.correct}`;
                choiceButtons[1].setAttribute('onclick', "checkFact('correct')");
            }

            // Update hint screen with topic-appropriate hints
            const hintText = document.getElementById('mission2HintText');
            const hintBox = document.getElementById('mission2HintBox');
            hintText.innerHTML = `Think about ${topic.toLowerCase()}.<br>What do you know?`;
            hintBox.innerHTML = `Let's think again.<br>What is true about ${topic.toLowerCase()}?`;

            // Read the question aloud
            speakText(`Which fact about ${topic} is wrong?`);
        }

        function nextMission2Question() {
            if (mission2QuestionCount >= 5) {
                // All 5 questions answered - show success
                showMission2Success();
            } else {
                loadMission2Question();
            }
        }

        function showMission2Success() {
            const topicData = gameState.currentTopicData;

            // Add all learned concepts to gameState
            mission2ConceptsLearned.forEach(concept => {
                gameState.conceptsLearned.push(concept);
            });

            // Update badge display dynamically
            const badgeDisplay = document.getElementById('mission2BadgeDisplay');
            const badgeName = `üîç ${topicData.name} Checker`;
            badgeDisplay.innerHTML = `<div class="badge">${badgeName}</div>`;

            showScreen('mission2-success');

            // Celebrate!
            triggerConfetti();
            playCorrectSound();
            speakText('Wow! You found all 5! You are a great fact finder!');
        }

        function checkFact(choice) {
            gameState.ideasTested.push(choice === 'wrong' ? 'Found the wrong fact' : 'Tested a fact');

            if (choice === 'wrong') {
                playCorrectSound(); // Play happy sound
                mission2QuestionCount++;
                mission2ConceptsLearned.push(currentMission2Fact.concept);

                if (mission2QuestionCount >= 5) {
                    // All 5 done - go to success
                    showMission2Success();
                } else {
                    // Show correct feedback and prepare for next question
                    document.getElementById('mission2CorrectFeedback').textContent = currentMission2Fact.concept;
                    // Show progress as stars
                    updateProgressStars(mission2QuestionCount);
                    document.getElementById('mission2CorrectProgress').innerHTML =
                        document.getElementById('mission2Progress').innerHTML;
                    showScreen('mission2-correct');
                    speakText(`Yes! ${currentMission2Fact.concept}`);
                }
            } else {
                playWrongSound(); // Play gentle "try again" sound
                document.getElementById('mission2HintBox').textContent = 'That one was true!';
                showScreen('mission2-hint');
                speakText('Oops! Try again!');
            }
        }

        // Get a random challenge that hasn't been used recently
        function getRandomChallenge(challenges, topicKey) {
            if (!usedChallengeIndices[topicKey]) {
                usedChallengeIndices[topicKey] = [];
            }

            // If all challenges have been used, reset the tracking
            if (usedChallengeIndices[topicKey].length >= challenges.length) {
                usedChallengeIndices[topicKey] = [];
            }

            // Find an unused challenge index
            let availableIndices = [];
            for (let i = 0; i < challenges.length; i++) {
                if (!usedChallengeIndices[topicKey].includes(i)) {
                    availableIndices.push(i);
                }
            }

            // Pick a random available index
            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedChallengeIndices[topicKey].push(randomIndex);

            return challenges[randomIndex];
        }

        // Mission completion
        function completeMission(missionNum) {
            if (!gameState.completedMissions.includes(missionNum)) {
                gameState.completedMissions.push(missionNum);

                // Add badge based on topic and mission
                const topicData = gameState.currentTopicData;
                const badges = [
                    null, // No mission 1
                    { id: `${gameState.currentTopic}-2`, name: `üîç ${topicData.name} Checker` }
                ];

                const badge = badges[missionNum - 1];
                if (badge && !gameState.badges.find(b => b.id === badge.id)) {
                    gameState.badges.push(badge);
                    // Trigger confetti for new badge!
                    triggerConfetti();
                    playCorrectSound();
                    speakText(`Yay! You earned a new badge!`);
                }
            }

            // Auto-save progress
            saveToLocalStorage();

            showScreen('missionSelect');
            updateBadgeDisplay();
            updateRecapButton();
        }

        function updateBadgeDisplay() {
            const badgeContainer = document.getElementById('badgeDisplay');
            const hangarSubtitle = document.getElementById('hangarSubtitle');

            if (gameState.currentTopic) {
                hangarSubtitle.textContent = `Your ${gameState.currentTopic} badges!`;
            } else {
                hangarSubtitle.textContent = 'Look at all the badges you\'ve earned!';
            }

            if (gameState.badges.length === 0) {
                badgeContainer.innerHTML = '<p class="subtitle">Complete missions to earn badges!</p>';
            } else {
                badgeContainer.innerHTML = gameState.badges
                    .map(badge => `<div class="badge">${badge.name}</div>`)
                    .join('');

                if (gameState.completedMissions.length === 2) {
                    badgeContainer.innerHTML += `
                        <div style="width: 100%; text-align: center; margin-top: 30px;">
                            <div class="celebration-emoji">üéâ</div>
                            <p class="subtitle" style="color: #ff6b6b; font-weight: bold; font-size: 24px;">
                                You completed all ${gameState.currentTopic} missions!<br>
                                You're an amazing thinker!
                            </p>
                        </div>
                    `;
                }
            }
        }

        // ========== ASK A QUESTION FEATURE ==========

        // Conversation history for context
        let chatHistory = [];

        // Curious helper prompt - answers questions and sparks curiosity
        const SOCRATIC_PROMPT = `You are a friendly helper for a 5-6 year old child.

STRICT RULES:
1. ONLY give the answer. NEVER ask a question back.
2. NO follow-up questions. NO "Do you know...?" NO "Can you...?" NO "What do you think...?"
3. End with a statement, NOT a question.
4. Include a "Learn more:" link at the end from your web search.

HOW TO TALK:
- Simple words only (say "big" not "large")
- Compare to kid things (big as a bus)
- Say "Wow!" or "Cool!" to be fun
- Short sentences (5-7 words max)

FORMAT:
1. Fun answer (2 sentences max)
2. One emoji
3. "Learn more:" with a markdown link [title](url)

GOOD EXAMPLES:
Kid: "How many moons does Saturn have?"
You: "Wow, Saturn has 146 moons! That is so many! ü™ê Learn more: [NASA Saturn](https://nasa.gov/saturn)"

Kid: "Why is the sky blue?"
You: "Light from the sun bounces in the air. Blue bounces the most! üíô Learn more: [Sky Colors](https://example.com)"

BAD (never do this):
"Can you guess?" ‚ùå
"Do you know what else?" ‚ùå
"What do you think?" ‚ùå

REMEMBER: Answer only. No questions. Always include a Learn more link at the end.`;

        // Get API key from localStorage
        function getApiKey() {
            return localStorage.getItem('openaiApiKey');
        }

        // Log questions locally for eval dataset
        function logQuestion(question, response) {
            try {
                const logs = JSON.parse(localStorage.getItem('questionLogs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    user: localStorage.getItem('userName') || 'Anonymous',
                    question: question,
                    response: response
                });
                localStorage.setItem('questionLogs', JSON.stringify(logs));
            } catch (e) {
                console.log('Question logging error:', e);
            }
        }

        // Export questions as CSV file
        function exportQuestionsCSV() {
            const logs = JSON.parse(localStorage.getItem('questionLogs') || '[]');
            if (logs.length === 0) {
                alert('No questions logged yet!');
                return;
            }

            // Create CSV content
            const headers = 'Timestamp,User,Question,Response\n';
            const rows = logs.map(log =>
                `"${log.timestamp}","${log.user}","${log.question.replace(/"/g, '""')}","${log.response.replace(/"/g, '""')}"`
            ).join('\n');
            const csv = headers + rows;

            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `curiosity-questions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Get question count for display
        function getQuestionCount() {
            const logs = JSON.parse(localStorage.getItem('questionLogs') || '[]');
            return logs.length;
        }

        // Save API key
        function saveOpenAIKey() {
            const key = document.getElementById('openaiKeyInput').value.trim();
            if (!key || !key.startsWith('sk-')) {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
                return;
            }
            localStorage.setItem('openaiApiKey', key);
            checkApiKeyAndShowChat();
        }

        // Check API key on screen show
        function checkApiKeyAndShowChat() {
            const apiKey = getApiKey();
            if (apiKey) {
                document.getElementById('apiKeySetup').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
            } else {
                document.getElementById('apiKeySetup').style.display = 'block';
                document.getElementById('chatContainer').style.display = 'none';
            }
        }

        // Convert markdown links to clickable HTML links
        function convertMarkdownLinks(text) {
            // Convert [text](url) to clickable links
            return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
                '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
        }

        // Add message to chat (with optional image)
        function addChatMessage(text, role, imageUrl = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role}`;
            // Convert markdown links and bold text to HTML
            let formattedText = convertMarkdownLinks(text);
            formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Add image if provided
            if (imageUrl && role === 'assistant') {
                bubble.innerHTML = `
                    <img src="${imageUrl}" alt="Picture"
                         style="max-width: 100%; border-radius: 12px; margin-bottom: 10px; display: block;"
                         onerror="this.style.display='none'">
                    ${formattedText}
                `;
            } else {
                bubble.innerHTML = formattedText;
            }
            messagesDiv.appendChild(bubble);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Auto-read assistant messages aloud
            if (role === 'assistant' && !text.includes('ü§î')) {
                speakText(text);
            }
        }

        // Extract image search keywords from question
        function getImageKeywords(question) {
            // Topics that benefit from images
            const visualTopics = [
                'animal', 'animals', 'dog', 'cat', 'lion', 'tiger', 'elephant', 'giraffe',
                'cheetah', 'bird', 'fish', 'whale', 'dolphin', 'shark', 'dinosaur', 'bug',
                'planet', 'moon', 'sun', 'star', 'earth', 'mars', 'jupiter', 'saturn',
                'rocket', 'space', 'astronaut', 'spaceship',
                'plane', 'airplane', 'jet', 'helicopter', 'car', 'train', 'boat', 'ship',
                'flower', 'tree', 'forest', 'ocean', 'mountain', 'volcano', 'rainbow',
                'castle', 'robot', 'dragon', 'unicorn'
            ];

            const lowerQ = question.toLowerCase();
            for (const topic of visualTopics) {
                if (lowerQ.includes(topic)) {
                    return topic;
                }
            }
            return null;
        }

        // Fetch image for a topic (uses Wikipedia free API)
        async function fetchImageForTopic(keyword) {
            if (!keyword) return null;
            try {
                // Use Wikipedia REST API (free, no auth required)
                const response = await fetch(
                    `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(keyword)}`,
                    { headers: { 'Accept': 'application/json' } }
                );
                if (!response.ok) return null;
                const data = await response.json();
                // Get thumbnail image if available
                if (data.thumbnail && data.thumbnail.source) {
                    // Request larger image by modifying the URL
                    let imageUrl = data.thumbnail.source;
                    // Wikipedia thumbnails can be resized - change to 400px width
                    imageUrl = imageUrl.replace(/\/\d+px-/, '/400px-');
                    return imageUrl;
                }
                return null;
            } catch {
                return null;
            }
        }

        // Send question to Gemini
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question) return;

            const apiKey = getApiKey();
            if (!apiKey) {
                checkApiKeyAndShowChat();
                return;
            }

            // Add user message
            addChatMessage(question, 'user');
            input.value = '';

            // Add thinking indicator
            addChatMessage('Hmm, let me think... ü§î', 'thinking');

            // Add to history (OpenAI format)
            chatHistory.push({ role: 'user', content: question });

            try {
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000);

                // Build conversation context for Responses API
                // Include recent conversation history for context (topic awareness)
                const recentHistory = chatHistory.slice(-6); // Keep last 6 messages for context
                const conversationContext = recentHistory.length > 0
                    ? `Recent conversation:\n${recentHistory.map(m => `${m.role}: ${m.content}`).join('\n')}\n\n`
                    : '';
                const fullInput = `${conversationContext}Child asks: "${question}"

IMPORTANT: Give a simple answer. Do NOT end with a question. No "Can you...?" or "Do you...?" - just answer and stop.`;

                // Use Responses API with web search for accurate facts
                const response = await fetch('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    signal: controller.signal,
                    body: JSON.stringify({
                        model: 'gpt-5.2',
                        instructions: SOCRATIC_PROMPT,
                        input: fullInput,
                        tools: [{ type: 'web_search' }],
                        tool_choice: 'required',
                        max_output_tokens: 250
                    })
                });

                clearTimeout(timeoutId);

                // Remove thinking bubble
                const messagesDiv = document.getElementById('chatMessages');
                const thinkingBubble = messagesDiv.querySelector('.thinking');
                if (thinkingBubble) thinkingBubble.remove();

                const data = await response.json();

                if (!response.ok) {
                    console.error('API Error:', data);
                    throw new Error(data.error?.message || 'API request failed');
                }

                // Extract text from Responses API output (find the message item)
                let reply = "Hmm, I'm not sure about that. Can you try asking in a different way?";
                if (data.output && Array.isArray(data.output)) {
                    const messageItem = data.output.find(item => item.type === 'message');
                    if (messageItem && messageItem.content && messageItem.content[0]) {
                        reply = messageItem.content[0].text || reply;
                    }
                }

                // Add to history (OpenAI format)
                chatHistory.push({ role: 'assistant', content: reply });

                // Check if topic could benefit from an image
                const imageKeyword = getImageKeywords(question);
                let imageUrl = null;
                if (imageKeyword) {
                    imageUrl = await fetchImageForTopic(imageKeyword);
                }

                // Display response with optional image
                addChatMessage(reply, 'assistant', imageUrl);

                // Log question and response for eval dataset
                logQuestion(question, reply);

            } catch (error) {
                console.error('OpenAI API error:', error);
                const messagesDiv = document.getElementById('chatMessages');
                const thinkingBubble = messagesDiv.querySelector('.thinking');
                if (thinkingBubble) thinkingBubble.remove();

                // Show detailed error for debugging
                addChatMessage(`Oops! Error: ${error.message}. Let's try again! üîÑ`, 'assistant');
            }
        }

        // Clear chat
        function clearChat() {
            chatHistory = [];
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = `
                <div class="chat-bubble assistant">
                    Hi! What are you curious about today? Ask me anything! üåü
                </div>
            `;
        }

        // Clear question input
        function clearQuestionInput() {
            document.getElementById('questionInput').value = '';
            document.getElementById('questionInput').focus();
        }

        // Voice input using Web Speech API
        let recognition = null;
        let isListening = false;

        function initVoiceRecognition() {
            // Check for Speech Recognition support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.log('Speech Recognition not supported');
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true; // Show partial results on mobile
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onresult = function(event) {
                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript;
                document.getElementById('questionInput').value = transcript;

                // Auto-send when we get a final result
                if (result.isFinal) {
                    stopVoiceInput();
                    // Small delay to show the text, then auto-send
                    setTimeout(() => {
                        if (transcript.trim()) {
                            sendQuestion();
                        }
                    }, 300);
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMsg = 'Voice input error. ';

                switch(event.error) {
                    case 'not-allowed':
                        errorMsg = 'Microphone access denied. Please allow microphone in browser settings.';
                        break;
                    case 'no-speech':
                        errorMsg = 'No speech detected. Please try again.';
                        break;
                    case 'network':
                        errorMsg = 'Network error. Please check your internet connection.';
                        break;
                    case 'audio-capture':
                        errorMsg = 'No microphone found. Please check your device.';
                        break;
                    default:
                        errorMsg = 'Voice input error: ' + event.error;
                }

                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    alert(errorMsg);
                }
                stopVoiceInput();
            };

            recognition.onend = function() {
                stopVoiceInput();
            };

            return true;
        }

        async function startVoiceInput() {
            // First, try to get microphone permission on mobile
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Release immediately
                } catch (err) {
                    alert('Please allow microphone access to use voice input.');
                    return;
                }
            }

            if (!recognition) {
                const supported = initVoiceRecognition();
                if (!supported) {
                    alert('Voice input is not supported on this device. Please type your question instead.');
                    return;
                }
            }

            if (isListening) {
                stopVoiceInput();
                return;
            }

            try {
                isListening = true;
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('listening');
                voiceBtn.innerHTML = 'üî¥';
                recognition.start();
            } catch (error) {
                console.error('Voice start error:', error);
                if (error.message.includes('already started')) {
                    recognition.stop();
                    setTimeout(() => startVoiceInput(), 100);
                } else {
                    alert('Could not start voice input. Please try again.');
                    stopVoiceInput();
                }
            }
        }

        function stopVoiceInput() {
            isListening = false;
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = 'üé§';
            }
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore stop errors
                }
            }
        }

        // Allow Enter key to send question
        document.getElementById('questionInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });

        // Initialize voice recognition
        initVoiceRecognition();

        // ========== END ASK A QUESTION FEATURE ==========

        // About modal functions
        function toggleAboutModal() {
            const modal = document.getElementById('aboutModal');
            modal.classList.toggle('active');
        }

        function closeAboutModalOutside(event) {
            if (event.target.id === 'aboutModal') {
                toggleAboutModal();
            }
        }

        // Feedback form functions
        function submitFeedback() {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            const feedbackEmail = document.getElementById('feedbackEmail').value.trim();

            if (!feedbackText) {
                alert('Please enter your feedback before sending!');
                return;
            }

            // Store feedback in localStorage (for demo purposes)
            const feedbackData = {
                text: feedbackText,
                email: feedbackEmail || 'Not provided',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };

            // Get existing feedback array or create new one
            const existingFeedback = JSON.parse(localStorage.getItem('curiosityExplorerFeedback')) || [];
            existingFeedback.push(feedbackData);
            localStorage.setItem('curiosityExplorerFeedback', JSON.stringify(existingFeedback));

            // Show success message
            document.getElementById('feedbackForm').style.display = 'none';
            document.getElementById('feedbackSuccess').style.display = 'block';

            // Log to console (useful if you want to see feedback during development)
            console.log('Feedback submitted:', feedbackData);
        }

        function resetFeedbackForm() {
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackEmail').value = '';
            document.getElementById('feedbackForm').style.display = 'block';
            document.getElementById('feedbackSuccess').style.display = 'none';
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('aboutModal');
                if (modal.classList.contains('active')) {
                    toggleAboutModal();
                }
            }
        });

        // Name management functions
        function getSavedName() {
            return localStorage.getItem('curiosityExplorerName');
        }

        function saveName() {
            const nameInput = document.getElementById('nameInput').value.trim();
            if (!nameInput) {
                alert('Please enter your name!');
                return;
            }

            localStorage.setItem('curiosityExplorerName', nameInput);
            displayUserName(nameInput);
            showScreen('welcome');
        }

        // Avatar selection (replaces typing name)
        function selectAvatar(emoji, name) {
            const fullName = `${emoji} ${name}`;
            localStorage.setItem('curiosityExplorerName', fullName);
            displayUserName(fullName);
            speakText(`Hi ${name}! Let's explore!`);
            showScreen('welcome');
        }

        function displayUserName(name) {
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.textContent = name;
            }
        }

        // Initialize app
        function initializeApp() {
            const savedName = getSavedName();

            if (savedName) {
                // Name exists - go to welcome screen
                displayUserName(savedName);
                document.getElementById('welcome').classList.add('active');
            } else {
                // No name - show name entry screen
                document.getElementById('nameEntry').classList.add('active');
            }

            updateBadgeDisplay();
            updateDashboard();
            initMuteButton();
        }

        // Allow Enter key to submit name
        document.getElementById('nameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveName();
            }
        });

        // Run initialization
        initializeApp();
    </script>
</body>
</html>